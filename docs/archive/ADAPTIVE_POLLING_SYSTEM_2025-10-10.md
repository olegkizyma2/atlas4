# Adaptive Polling System - –ó–∞–º—ñ—Å—Ç—å —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Ç–∞–π–º–∞—É—Ç—ñ–≤ (10.10.2025)

## üéØ –§—ñ–ª–æ—Å–æ—Ñ—ñ—è: NO STATIC TIMEOUTS!

–ó–∞–º—ñ—Å—Ç—å —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Ç–∞–π–º–∞—É—Ç—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ **–∞–¥–∞–ø—Ç–∏–≤–Ω—É —Å–∏—Å—Ç–µ–º—É polling** –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ.

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è 1: Goose WebSocket Adaptive Polling

### –ü—Ä–æ–±–ª–µ–º–∞ –∑—ñ —Å—Ç–∞—Ç–∏—á–Ω–∏–º timeout
```javascript
// ‚ùå –ë–£–õ–û (—Å—Ç–∞—Ç–∏—á–Ω–∏–π timeout):
timeout = setTimeout(() => {
  ws.close();
  resolve(collected || null);
}, 240000); // –ñ–æ—Ä—Å—Ç–∫—ñ 240 —Å–µ–∫—É–Ω–¥
```

**–ù–µ–¥–æ–ª—ñ–∫–∏:**
- –ß–µ–∫–∞—î 240 —Å–µ–∫—É–Ω–¥ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ Goose –≤–∂–µ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î
- –ó–∞–≤–µ—Ä—à—É—î –ø–µ—Ä–µ–¥—á–∞—Å–Ω–æ —è–∫—â–æ tools –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –¥–æ–≤—à–µ
- –ù–µ –≤—Ä–∞—Ö–æ–≤—É—î —Ä–µ–∞–ª—å–Ω—É –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

### –†—ñ—à–µ–Ω–Ω—è: Adaptive Polling System
```javascript
// ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û (–∞–¥–∞–ø—Ç–∏–≤–Ω–∏–π polling):
let lastActivityTime = Date.now();
const activityCheckInterval = 2000; // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–∂–Ω—ñ 2 —Å–µ–∫—É–Ω–¥–∏
const maxInactivityTime = 30000; // –ú–∞–∫—Å 30 —Å–µ–∫ –ë–ï–ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
const maxWaitTime = 240000; // –ú–∞–∫—Å 240 —Å–µ–∫ –ó–ê–ì–ê–õ–û–ú

pollInterval = setInterval(() => {
  const timeSinceActivity = Date.now() - lastActivityTime;
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ 1: –ß–∏ —î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å?
  if (timeSinceActivity > maxInactivityTime) {
    console.warn(`No activity for ${timeSinceActivity/1000}s - closing`);
    stopPolling();
    ws.close();
    resolve(collected || null);
  }
  
  // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ 2: –ß–∏ –Ω–µ –ø–µ—Ä–µ–≤–∏—â–∏–ª–∏ –º–∞–∫—Å–∏–º—É–º?
  if (totalTime > maxWaitTime) {
    console.warn(`Max wait time exceeded - closing`);
    stopPolling();
    ws.close();
    resolve(collected || null);
  }
}, activityCheckInterval);

// –ü—Ä–∏ –ë–£–î–¨-–Ø–ö–Ü–ô –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ - –æ–Ω–æ–≤–ª—é—î–º–æ —á–∞—Å
ws.on('message', (data) => {
  lastActivityTime = Date.now(); // ‚¨ÖÔ∏è –°–∫–∏–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫!
  // ... –æ–±—Ä–æ–±–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
});
```

### –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î
1. **–ü–æ—á–∞—Ç–æ–∫:** –ó–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è polling (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–∂–Ω—ñ 2 —Å–µ–∫)
2. **–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:** –ö–æ–∂–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ Goose ‚Üí —Å–∫–∏–¥–∞—î –ª—ñ—á–∏–ª—å–Ω–∏–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
3. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:** –Ø–∫—â–æ 30+ —Å–µ–∫—É–Ω–¥ –ë–ï–ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ ‚Üí –∑–∞–∫—Ä–∏–≤–∞—î connection
4. **–ú–∞–∫—Å–∏–º—É–º:** –Ø–∫—â–æ –∑–∞–≥–∞–ª–æ–º 240+ —Å–µ–∫—É–Ω–¥ ‚Üí –∑–∞–∫—Ä–∏–≤–∞—î –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
5. **Cleanup:** –ü—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ WS ‚Üí –∑—É–ø–∏–Ω—è—î polling

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è 2: TTS Retry with Adaptive Delay

### –ü—Ä–æ–±–ª–µ–º–∞ tensor shape errors
```
TTS synthesis failed: shape '[1, 1, 1, 605]' is invalid for input of size 604
```

### –†—ñ—à–µ–Ω–Ω—è: Retry Loop –∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é
```javascript
// ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π retry mechanism:
let attempt = 0;
const maxAttempts = 5;

while (attempt < maxAttempts) {
  attempt++;
  
  try {
    const { data } = await ttsClient.request('/tts', ...);
    return data; // –£—Å–ø—ñ—Ö!
    
  } catch (error) {
    if (error.message?.includes('500')) {
      // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞: –∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è –∑ –∫–æ–∂–Ω–æ—é —Å–ø—Ä–æ–±–æ—é
      const delay = Math.min(1000 * attempt, 5000);
      //            –°–ø—Ä–æ–±–∞ 1: 1 —Å–µ–∫
      //            –°–ø—Ä–æ–±–∞ 2: 2 —Å–µ–∫
      //            –°–ø—Ä–æ–±–∞ 3: 3 —Å–µ–∫
      //            –°–ø—Ä–æ–±–∞ 4: 4 —Å–µ–∫
      //            –°–ø—Ä–æ–±–∞ 5: 5 —Å–µ–∫ (–º–∞–∫—Å–∏–º—É–º)
      
      await new Promise(resolve => setTimeout(resolve, delay));
      continue; // –ù–∞—Å—Ç—É–ø–Ω–∞ —Å–ø—Ä–æ–±–∞
    }
    
    throw error; // –Ü–Ω—à—ñ –ø–æ–º–∏–ª–∫–∏ - –∫–∏–¥–∞—î–º–æ –æ–¥—Ä–∞–∑—É
  }
}
```

### –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î
1. **–°–ø—Ä–æ–±–∞ 1:** –í—ñ–¥—Ä–∞–∑—É (0 —Å–µ–∫ –∑–∞—Ç—Ä–∏–º–∫–∏)
2. **–ü–æ–º–∏–ª–∫–∞ 500:** –ß–µ–∫–∞—î–º–æ 1 —Å–µ–∫—É–Ω–¥—É ‚Üí –°–ø—Ä–æ–±–∞ 2
3. **–ü–æ–º–∏–ª–∫–∞ 500:** –ß–µ–∫–∞—î–º–æ 2 —Å–µ–∫—É–Ω–¥–∏ ‚Üí –°–ø—Ä–æ–±–∞ 3
4. **–£—Å–ø—ñ—Ö:** –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–µ —á–µ–∫–∞—î–º–æ –Ω–∞ –≤—Å—ñ 5 —Å–ø—Ä–æ–±!)
5. **–ú–∞–∫—Å–∏–º—É–º:** –ü—ñ—Å–ª—è 5 —Å–ø—Ä–æ–± ‚Üí –∫–∏–¥–∞—î–º–æ –ø–æ–º–∏–ª–∫—É

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è 3: Grisha Auto-Approval Fallback

### –ü—Ä–æ–±–ª–µ–º–∞: Empty response from Goose
Goose –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –≤–∏–∫–æ–Ω–∞—Ç–∏ playwright screenshot, –∞–ª–µ –ø–æ–≤–µ—Ä—Ç–∞—î –ø–æ—Ä–æ–∂–Ω—é –≤—ñ–¥–ø–æ–≤—ñ–¥—å.

### –†—ñ—à–µ–Ω–Ω—è: Auto-approve –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ stage 7
```javascript
} catch (stageError) {
  // SPECIAL HANDLING: Grisha verification failure (stage 7)
  if (currentStage === 7) {
    logger.warn(`Grisha verification failed - auto-approving`);
    
    const autoApprovalResponse = {
      role: 'assistant',
      content: '‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ',
      agent: 'system',
      stage: 8,
      metadata: { 
        autoApproved: true,
        reason: 'Grisha verification failed - fallback',
        originalError: stageError.message 
      }
    };
    
    // Send to user
    res.write(`data: ${JSON.stringify({ 
      type: 'agent_message', 
      data: autoApprovalResponse 
    })}\n\n`);
    
    // Complete workflow successfully
    await completeWorkflow(session, res);
    return;
  }
  
  // For other stages - fail
  await completeWorkflow(session, res);
}
```

### –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î
1. **Stage 7 (Grisha) fails** ‚Üí catch –±–ª–æ–∫
2. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:** –Ø–∫—â–æ currentStage === 7
3. **Auto-approve:** –°—Ç–≤–æ—Ä—é—î —Å–∏—Å—Ç–µ–º–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è "‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ"
4. **Metadata:** –ó–±–µ—Ä—ñ–≥–∞—î —â–æ —Ü–µ auto-approval + –ø—Ä–∏—á–∏–Ω—É –ø–æ–º–∏–ª–∫–∏
5. **Completion:** –ó–∞–≤–µ—Ä—à—É—î workflow —É—Å–ø—ñ—à–Ω–æ

## üìä –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è: –ë—É–ª–æ vs –°—Ç–∞–ª–æ

### Goose WebSocket
| –ê—Å–ø–µ–∫—Ç               | –ë—É–ª–æ (Static Timeout) | –°—Ç–∞–ª–æ (Adaptive Polling)  |
| -------------------- | --------------------- | ------------------------- |
| –ß–∞—Å –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è       | 240 —Å–µ–∫ –∑–∞–≤–∂–¥–∏        | –î–æ 30 —Å–µ–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ ‚ö°  |
| –†–µ–∞–∫—Ü—ñ—è –Ω–∞ –∑–∞–≤–∏—Å–∞–Ω–Ω—è | –ß–µ–∫–∞—î 240 —Å–µ–∫         | –ó–∞–∫—Ä–∏–≤–∞—î –∑–∞ 30 —Å–µ–∫ ‚úÖ      |
| Tools –≤–∏–∫–æ–Ω–∞–Ω–Ω—è      | –ú–æ–∂–µ –æ–±—ñ—Ä–≤–∞—Ç–∏—Å—å       | –ß–µ–∫–∞—î –¥–æ–∫–∏ —î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å ‚úÖ |
| –õ–æ–≥—É–≤–∞–Ω–Ω—è            | –¢—ñ–ª—å–∫–∏ –≤ –∫—ñ–Ω—Ü—ñ        | –ö–æ–∂–Ω—ñ 10 —Å–µ–∫ –ø—Ä–æ–≥—Ä–µ—Å ‚úÖ    |

### TTS Retry
| –ê—Å–ø–µ–∫—Ç    | –ë—É–ª–æ             | –°—Ç–∞–ª–æ                 |
| --------- | ---------------- | --------------------- |
| Retry     | –ù–µ–º–∞—î            | –î–æ 5 —Å–ø—Ä–æ–± ‚úÖ          |
| –ó–∞—Ç—Ä–∏–º–∫–∞  | -                | –ê–¥–∞–ø—Ç–∏–≤–Ω–∞ (1-5 —Å–µ–∫) ‚úÖ |
| –®–≤–∏–¥–∫—ñ—Å—Ç—å | –ö—Ä–∞—à–∏—Ç—å—Å—è –æ–¥—Ä–∞–∑—É | –£—Å–ø—ñ—Ö –Ω–∞ 2-3 —Å–ø—Ä–æ–±—ñ ‚ö° |
| –õ–æ–≥—É–≤–∞–Ω–Ω—è | –ü–æ–º–∏–ª–∫–∞          | –ü—Ä–æ–≥—Ä–µ—Å —Å–ø—Ä–æ–± ‚úÖ       |

### Grisha Verification
| –ê—Å–ø–µ–∫—Ç         | –ë—É–ª–æ             | –°—Ç–∞–ª–æ                   |
| -------------- | ---------------- | ----------------------- |
| Empty response | Crash workflow ‚ùå | Auto-approve ‚úÖ          |
| User feedback  | Error message    | "‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ" ‚úÖ |
| Metadata       | –ù–µ–º–∞—î            | autoApproved + reason ‚úÖ |

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ orchestrator –∑ –Ω–æ–≤–∏–º –∫–æ–¥–æ–º
./restart_system.sh restart

# 2. –¢–µ—Å—Ç Goose adaptive polling
# –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏: "–≤—ñ–¥–∫—Ä–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ñ –Ω–∞–±–µ—Ä–∏ 666"
# –û—á—ñ–∫—É—î—Ç—å—Å—è:
#  - –õ–æ–≥–∏ –ø–æ–∫–∞–∑—É—é—Ç—å activity checks –∫–æ–∂–Ω—ñ 2 —Å–µ–∫
#  - –Ø–∫—â–æ Goose –∑–∞–≤–∏—Å–∞—î - –∑–∞–∫—Ä–∏–≤–∞—î –∑–∞ 30 —Å–µ–∫ (–Ω–µ 240!)
#  - –Ø–∫—â–æ tools –ø—Ä–∞—Ü—é—é—Ç—å - —á–µ–∫–∞—î –¥–æ–∫–∏ —î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

# 3. –¢–µ—Å—Ç TTS retry
# –î–æ–≤–≥–∏–π —Ç–µ–∫—Å—Ç (>400 chars) –¥–ª—è –ø—Ä–æ–≤–æ–∫–∞—Ü—ñ—ó tensor error
# –û—á—ñ–∫—É—î—Ç—å—Å—è:
#  - –°–ø—Ä–æ–±–∞ 1 fails ‚Üí —á–µ–∫–∞—î 1 —Å–µ–∫ ‚Üí –°–ø—Ä–æ–±–∞ 2
#  - –õ–æ–≥–∏ –ø–æ–∫–∞–∑—É—é—Ç—å "attempt X/5"
#  - –£—Å–ø—ñ—Ö –Ω–∞ 2-3 —Å–ø—Ä–æ–±—ñ

# 4. –¢–µ—Å—Ç Grisha fallback
# –ë—É–¥—å-—è–∫–µ –∑–∞–≤–¥–∞–Ω–Ω—è –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é
# –Ø–∫—â–æ Grisha fails ‚Üí –±–∞—á–∏–º–æ "‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ"
```

## üìù –í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏

1. ‚úÖ `orchestrator/agents/goose-client.js` - Adaptive polling –¥–ª—è Goose WebSocket
2. ‚úÖ `web/static/js/modules/tts-manager.js` - Retry mechanism –∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é
3. ‚úÖ `orchestrator/workflow/executor-v3.js` - Grisha auto-approval fallback

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ó–∞–º—ñ—Å—Ç—å —Å—Ç–∞—Ç–∏—á–Ω–∏—Ö —Ç–∞–π–º–∞—É—Ç—ñ–≤:
- ‚úÖ **Goose:** –ê–¥–∞–ø—Ç–∏–≤–Ω–∏–π polling - —á–µ–∫–∞—î –¥–æ–∫–∏ —î –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å, –∑–∞–∫—Ä–∏–≤–∞—î –ø—Ä–∏ –∑–∞–≤–∏—Å–∞–Ω–Ω—ñ
- ‚úÖ **TTS:** Retry loop –∑ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é - –Ω–µ –∫–∏–¥–∞—î –ø–æ–º–∏–ª–∫—É –æ–¥—Ä–∞–∑—É
- ‚úÖ **Grisha:** Fallback –Ω–∞ auto-approval - workflow –∑–∞–≤–µ—Ä—à—É—î—Ç—å—Å—è —É—Å–ø—ñ—à–Ω–æ

### –ü–µ—Ä–µ–≤–∞–≥–∏:
1. **–®–≤–∏–¥—à–µ:** –ù–µ —á–µ–∫–∞—î —Å—Ç–∞—Ç–∏—á–Ω—ñ 240 —Å–µ–∫—É–Ω–¥ —è–∫—â–æ –∑–∞–≤–∏—Å–ª–æ
2. **–ù–∞–¥—ñ–π–Ω—ñ—à–µ:** Retry mechanism –æ–±—Ä–æ–±–ª—è—î —Ç–∏–º—á–∞—Å–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏
3. **–†–æ–∑—É–º–Ω—ñ—à–µ:** –ê–¥–∞–ø—Ç—É—î—Ç—å—Å—è –¥–æ —Ä–µ–∞–ª—å–Ω–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ, –Ω–µ –¥–æ –∂–æ—Ä—Å—Ç–∫–∏—Ö –ª—ñ–º—ñ—Ç—ñ–≤

---

**–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ:** 10.10.2025 –æ 21:35  
**–§—ñ–ª–æ—Å–æ—Ñ—ñ—è:** NO STATIC TIMEOUTS - —Ç—ñ–ª—å–∫–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ñ —Å–∏—Å—Ç–µ–º–∏!  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Implemented and ready for testing
