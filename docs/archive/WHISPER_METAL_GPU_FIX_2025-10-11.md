# Whisper Metal GPU Fix - 2025-10-11 01:10

## –ü—Ä–æ–±–ª–µ–º–∞

Whisper –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ **`whisper-cli`** –±—ñ–Ω–∞—Ä–Ω–∏–∫ —è–∫–∏–π **–ù–ï –ø—ñ–¥—Ç—Ä–∏–º—É—î Metal GPU** —á–µ—Ä–µ–∑ `-ngl` –ø–∞—Ä–∞–º–µ—Ç—Ä.

## –°–∏–º–ø—Ç–æ–º–∏

1. **–ú–æ–¥–µ–ª—å Large-v3** –ø—Ä–∞—Ü—é–≤–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ (2.9GB)
2. **–†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è** –±—É–ª–æ –∫–æ—Ä–µ–∫—Ç–Ω–∏–º
3. –ê–ª–µ **Metal GPU –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è** - –≤–µ—Å—å inference –Ω–∞ CPU
4. –ü–æ–≤—ñ–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó (~2.5 —Å–µ–∫—É–Ω–¥–∏ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∞—É–¥—ñ–æ)

## –ö–æ—Ä—ñ–Ω—å –ø—Ä–æ–±–ª–µ–º–∏

### Binary –≤–∏–±—ñ—Ä –≤ `restart_system.sh`:

```bash
# –î–û –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø (–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç whisper-cli):
if [ -x "whisper-cli" ]; then
    WHISPER_CPP_BIN="whisper-cli"  # ‚ùå –ù–ï –ø—ñ–¥—Ç—Ä–∏–º—É—î -ngl
else
    WHISPER_CPP_BIN="main"
fi
```

### –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ GPU –≤ —Ä—ñ–∑–Ω–∏—Ö –±—ñ–Ω–∞—Ä–Ω–∏–∫–∞—Ö:

| –ë—ñ–Ω–∞—Ä–Ω–∏–∫                | `-ngl` flag              | Metal GPU | –°—Ç–∞—Ç—É—Å           |
| ----------------------- | ------------------------ | --------- | ---------------- |
| **main** (—Å—Ç–∞—Ä–∏–π)       | ‚úÖ YES                    | ‚úÖ WORKS   | ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ |
| **whisper-cli** (–Ω–æ–≤–∏–π) | ‚ùå NO (—Ç—ñ–ª—å–∫–∏ `--no-gpu`) | ‚ùå NO      | ‚ùå –ù–ï –ø—ñ–¥—Ö–æ–¥–∏—Ç—å   |
| **whisper-server**      | ‚úÖ YES                    | ‚úÖ WORKS   | –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞     |

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏:

```bash
# whisper-cli –º–∞—î –¢–Ü–õ–¨–ö–ò --no-gpu (–≤–∏–º–∫–Ω—É—Ç–∏ GPU):
$ whisper-cli --help | grep gpu
  -ng, --no-gpu  [false] disable GPU

# main –ø—ñ–¥—Ç—Ä–∏–º—É—î -ngl (–∫—ñ–ª—å–∫—ñ—Å—Ç—å —à–∞—Ä—ñ–≤ –Ω–∞ GPU):
$ main --help | grep ngl
  -ngl N, --n-gpu-layers N  [0] number of layers to offload to GPU
```

## –†—ñ—à–µ–Ω–Ω—è

### 1. –ó–º—ñ–Ω–µ–Ω–æ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –≤ `restart_system.sh` (—Ä—è–¥–∫–∏ 44-54):

```bash
# –ü–Ü–°–õ–Ø –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø (–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç main):
# Prefer OLD 'main' binary for Metal GPU support via -ngl flag
# (whisper-cli does NOT support -ngl, only --no-gpu)
if [ -z "${WHISPER_CPP_BIN:-}" ]; then
    if [ -x "$REPO_ROOT/third_party/whisper.cpp.upstream/build/bin/main" ]; then
        WHISPER_CPP_BIN="$REPO_ROOT/third_party/whisper.cpp.upstream/build/bin/main"
    elif [ -x "$REPO_ROOT/third_party/whisper.cpp.upstream/build/bin/whisper-cli" ]; then
        WHISPER_CPP_BIN="$REPO_ROOT/third_party/whisper.cpp.upstream/build/bin/whisper-cli"
    else
        WHISPER_CPP_BIN="$REPO_ROOT/third_party/whisper.cpp/main"
    fi
else
    WHISPER_CPP_BIN="${WHISPER_CPP_BIN}"
fi
```

### 2. –ö–æ–¥ –≤ `whispercpp_service.py` –≤–∂–µ –±—É–≤ –≥–æ—Ç–æ–≤–∏–π:

```python
# –î–æ–±–∞–≤–ª—è–µ–º offload-—Ñ–ª–∞–≥ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ –±–∏–Ω–∞—Ä—è 'main'
if 'whisper-cli' not in bin_name and WHISPER_CPP_NGL > 0:
    cmd.insert(10, '-ngl')
    cmd.insert(11, str(WHISPER_CPP_NGL))  # 20 —à–∞—Ä—ñ–≤ –Ω–∞ GPU
```

‚úÖ **–¶–µ–π –∫–æ–¥ —Ç–µ–ø–µ—Ä –ü–†–ê–¶–Æ–Ñ** —Ç–æ–º—É —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è `main` –∑–∞–º—ñ—Å—Ç—å `whisper-cli`!

## –†–µ–∑—É–ª—å—Ç–∞—Ç –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### –î–û (whisper-cli):

```bash
whisper-cli -m model.bin -f audio.wav -l uk -t 6 ...
# ‚ùå –ë–ï–ó -ngl –ø–∞—Ä–∞–º–µ—Ç—Ä—É
# ‚ùå GPU –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
# ‚è±Ô∏è –ü–æ–≤—ñ–ª—å–Ω–∏–π inference –Ω–∞ CPU
```

### –ü–Ü–°–õ–Ø (main):

```bash
main -m model.bin -f audio.wav -l uk -t 6 -ngl 20 ...
# ‚úÖ –ó -ngl 20 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
# ‚úÖ 20 —à–∞—Ä—ñ–≤ –º–æ–¥–µ–ª—ñ –Ω–∞ Metal GPU
# ‚ö° –®–≤–∏–¥–∫–∏–π inference –∑ GPU –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è–º
```

## –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó

```bash
# Health endpoint –ø–æ–∫–∞–∑—É—î –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é:
curl -s http://localhost:3002/health | jq

{
  "backend": "whisper.cpp",
  "binary": ".../build/bin/main",           # ‚úÖ main (–ù–ï whisper-cli)
  "device": "metal",                        # ‚úÖ Metal GPU
  "model_path": ".../ggml-large-v3.bin",   # ‚úÖ Large-v3
  "ngl": 20,                                # ‚úÖ 20 —à–∞—Ä—ñ–≤ –Ω–∞ GPU
  "threads": 6,
  "status": "ok"
}
```

## –õ–æ–≥–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è

```
2025-10-11 01:07:15,676 [INFO] atlas.whispercpp: Binary: .../build/bin/main
2025-10-11 01:07:15,676 [INFO] atlas.whispercpp: Device: metal (ngl=20)

2025-10-11 01:09:12,923 [INFO] atlas.whispercpp: Running whisper.cpp: 
  .../build/bin/main 
  -m .../ggml-large-v3.bin 
  -f .../audio.wav 
  -l uk 
  -t 6 
  -oj 
  -ngl 20                    # ‚úÖ –¢–ï–ü–ï–† –ü–†–ò–°–£–¢–ù–Ü–ô!
  -of .../out 
  --best-of 5 
  --beam-size 5 
  --prompt "–¶–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞..."
```

## –û—á—ñ–∫—É–≤–∞–Ω—ñ –ø–µ—Ä–µ–≤–∞–≥–∏

### üöÄ –®–≤–∏–¥–∫—ñ—Å—Ç—å:

- **CPU-only** (whisper-cli): ~2.5s –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∞—É–¥—ñ–æ
- **Metal GPU** (main -ngl 20): ~0.8-1.2s –¥–ª—è —Ç–æ–≥–æ –∂ –∞—É–¥—ñ–æ
- **–ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è:** 2-3x —à–≤–∏–¥—à–µ

### üíé –Ø–∫—ñ—Å—Ç—å:

- –ú–æ–¥–µ–ª—å –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è —Ç–∞ –∂ (Large-v3)
- –Ø–∫—ñ—Å—Ç—å —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –ù–ï –∑–º—ñ–Ω—é—î—Ç—å—Å—è
- –¢—ñ–ª—å–∫–∏ —à–≤–∏–¥–∫—ñ—Å—Ç—å –ø–æ–∫—Ä–∞—â—É—î—Ç—å—Å—è

### üîã –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:

- Metal GPU –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–π –¥–ª—è Apple Silicon
- –ú–µ–Ω—à–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ CPU
- –ö—Ä–∞—â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤ Mac

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ç–µ—Å—Ç:

```bash
# 1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É
./restart_system.sh restart

# 2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é
curl -s http://localhost:3002/health | jq -r '.binary, .ngl'
# –ú–∞—î –ø–æ–∫–∞–∑–∞—Ç–∏:
# .../build/bin/main
# 20

# 3. –¢–µ—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó
curl -X POST http://localhost:3002/transcribe \
  -F "audio=@ukrainian-tts/user_text.wav" \
  -F "language=uk" | jq -r '.text'

# 4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏ –Ω–∞ -ngl
tail -10 logs/whisper.log | grep "ngl 20"
# –ú–∞—î –ø–æ–∫–∞–∑–∞—Ç–∏: ... -ngl 20 -of ...
```

### –û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
‚úÖ Binary: main (–ù–ï whisper-cli)
‚úÖ NGL: 20 —à–∞—Ä—ñ–≤ –Ω–∞ GPU
‚úÖ –õ–æ–≥–∏ –º—ñ—Å—Ç—è—Ç—å "-ngl 20"
‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è –ø—Ä–∞—Ü—é—î —à–≤–∏–¥—à–µ
‚úÖ –Ø–∫—ñ—Å—Ç—å –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤—ñ–¥–º—ñ–Ω–Ω–æ—é
```

## –§–∞–π–ª–∏ –∑–º—ñ–Ω–µ–Ω—ñ

1. **`restart_system.sh`** (—Ä—è–¥–∫–∏ 44-54)
   - –ó–º—ñ–Ω–µ–Ω–æ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: `main` ‚Üí `whisper-cli` (–∑–∞–º—ñ—Å—Ç—å –Ω–∞–≤–ø–∞–∫–∏)
   - –î–æ–¥–∞–Ω–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ –ø—Ä–æ –ø—ñ–¥—Ç—Ä–∏–º–∫—É Metal GPU
   - –õ–æ–≥—ñ–∫–∞ –≤–∏–±–æ—Ä—É –±—ñ–Ω–∞—Ä–Ω–∏–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–∞

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è (–ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ)

### Option 1: Whisper-server
- –ü—ñ–¥—Ç—Ä–∏–º—É—î `-ngl` —á–µ—Ä–µ–∑ API
- –°–∫–ª–∞–¥–Ω—ñ—à–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
- –ó–∞–π–≤–∏–π –æ–≤–µ—Ä—Ö–µ–¥

### Option 2: –í–ª–∞—Å–Ω–∏–π build whisper-cli –∑ Metal
- –ü–æ—Ç—Ä–µ–±—É—î recompile –∑ Metal –ø—Ä–∞–ø–æ—Ä—Ü—è–º–∏
- –ù–æ–≤—ñ—à—ñ –≤–µ—Ä—Å—ñ—ó –º–æ–∂—É—Ç—å –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ Metal —ñ–Ω–∞–∫—à–µ
- –ù–µ–ø–æ—Ç—Ä—ñ–±–Ω–∞ —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å

### Option 3: Python faster-whisper
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î CUDA/ROCm (–ù–ï Metal)
- –ü–æ–≤—ñ–ª—å–Ω—ñ—à–∏–π –Ω–∞ Mac
- –ë—ñ–ª—å—à–µ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π

‚úÖ **–†—ñ—à–µ–Ω–Ω—è –∑ `main` –±—ñ–Ω–∞—Ä–Ω–∏–∫–æ–º –Ω–∞–π–ø—Ä–æ—Å—Ç—ñ—à–µ —ñ –Ω–∞–π–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à–µ!**

## –ö—Ä–∏—Ç–∏—á–Ω—ñ –Ω–æ—Ç–∞—Ç–∫–∏

### ‚ö†Ô∏è –ù–µ –ø–ª—É—Ç–∞—Ç–∏ —Ñ–ª–∞–≥–∏:

```bash
-ngl 20      # Offload 20 layers TO GPU (main binary)
--no-gpu     # DISABLE GPU completely (whisper-cli)
```

–¶–µ **–ü–†–û–¢–ò–õ–ï–ñ–ù–Ü** –ø–∞—Ä–∞–º–µ—Ç—Ä–∏!

### üìù –ß–æ–º—É main "—Å—Ç–∞—Ä–∏–π" –∞–ª–µ –∫—Ä–∞—â–∏–π:

- `main` - legacy –±—ñ–Ω–∞—Ä–Ω–∏–∫ –∑ –ø–æ–≤–Ω–æ—é –ø—ñ–¥—Ç—Ä–∏–º–∫–æ—é –≤—Å—ñ—Ö —Ñ—ñ—á
- `whisper-cli` - –Ω–æ–≤–∏–π "—Å–ø—Ä–æ—â–µ–Ω–∏–π" CLI –±–µ–∑ –¥–µ—è–∫–∏—Ö –æ–ø—Ü—ñ–π
- –î–ª—è production –∑ Metal GPU ‚Üí –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `main`

### üîÆ –ú–∞–π–±—É—Ç–Ω—î:

–ö–æ–ª–∏ `whisper-cli` –æ—Ç—Ä–∏–º–∞—î –ø—ñ–¥—Ç—Ä–∏–º–∫—É Metal —á–µ—Ä–µ–∑ —ñ–Ω—à—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ `--device metal`), –º–æ–∂–Ω–∞ –±—É–¥–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ –Ω—å–æ–≥–æ. –ü–æ–∫–∏ —â–æ - `main` —î –Ω–∞–π–∫—Ä–∞—â–∏–º –≤–∏–±–æ—Ä–æ–º.

## –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)

1. **Benchmark —Ç–µ—Å—Ç–∏** - –ø–æ—Ä—ñ–≤–Ω—è—Ç–∏ —à–≤–∏–¥–∫—ñ—Å—Ç—å –¥–æ/–ø—ñ—Å–ª—è
2. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ GPU** - –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—å —â–æ Metal GPU –∞–∫—Ç–∏–≤–Ω–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
3. **Temperature monitoring** - –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞–≥—Ä—ñ–≤ GPU –ø—ñ–¥ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è–º
4. **Batch processing** - —Ç–µ—Å—Ç–∏ –∑ –º–Ω–æ–∂–∏–Ω–Ω–∏–º–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–∏–º–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è–º–∏

---

**–î–æ–∫—É–º–µ–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ:** 11 –∂–æ–≤—Ç–Ω—è 2025, 01:10  
**–í–µ—Ä—Å—ñ—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ ‚úÖ  
**–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Ç—Ä—ñ–±–µ–Ω:** ‚úÖ DONE
