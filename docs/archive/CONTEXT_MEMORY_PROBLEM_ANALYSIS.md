# –ê–ù–ê–õ–Ü–ó –ü–†–û–ë–õ–ï–ú–ò –ö–û–ù–¢–ï–ö–°–¢–£ –¢–ê –ü–ê–ú'–Ø–¢–Ü –í ATLAS v4.0

**–î–∞—Ç–∞ –∞–Ω–∞–ª—ñ–∑—É:** 10 –∂–æ–≤—Ç–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ù–ê –ü–†–û–ë–õ–ï–ú–ê - —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Ç—Ä–∏–º–∞—î –∫–æ–Ω—Ç–µ–∫—Å—Ç, –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —à–∞–±–ª–æ–Ω–Ω–æ  
**–ê–Ω–∞–ª—ñ—Ç–∏–∫:** GitHub Copilot + –û–ª–µ–≥ –ú–∏–∫–æ–ª–∞–π–æ–≤–∏—á

---

## 1. –í–ò–Ø–í–õ–ï–ù–Ü –ü–†–û–ë–õ–ï–ú–ò

### 1.1 –°–∏–º–ø—Ç–æ–º–∏ (–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ —á–∞—Ç—É)
```
03:03:28 [USER]: —è–∫ –≤ —Ç–µ–±–µ –¥—ñ–ª–∞ —ñ —Ä–æ–∑—É–º—ñ—î—à —á–∏ —Ç–∏ —Ö—Ç–æ –∑ —Ç–æ–±–æ—é –ø–µ—Ä–µ–ø–∏—Å—É—î—Ç—å—Å—è?
03:03:32 [ATLAS]: –í—ñ—Ç–∞—é! –Ø ‚Äî –ê—Ç–ª–∞—Å, —Ü–∏—Ñ—Ä–æ–≤–µ –≤—Ç—ñ–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É...

03:04:02 [USER]: –ú–æ–∂–ª–∏–≤–æ –∞–Ω—ñ–∫—Ç–¥–æ—Ç —Ç–æ–¥—ñ.
03:04:06 [ATLAS]: –í—ñ—Ç–∞—é, —è –ê—Ç–ª–∞—Å, —Ü–∏—Ñ—Ä–æ–≤–µ –≤—Ç—ñ–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É...
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –Ü–î–ï–ù–¢–ò–ß–ù–ò–ú —à–∞–±–ª–æ–Ω–æ–º –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Ä–æ–∑–º–æ–≤–∏.

---

## 2. –ö–û–†–Ü–ù–¨ –ü–†–û–ë–õ–ï–ú–ò: –ê–†–•–Ü–¢–ï–ö–¢–£–†–ù–ò–ô –ê–ù–ê–õ–Ü–ó

### 2.1 –ü—Ä–æ–±–ª–µ–º–∞ #1: –ù–∞–¥–º—ñ—Ä–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å fallback –º–µ—Ö–∞–Ω—ñ–∑–º—ñ–≤

**–õ–æ–∫–∞—Ü—ñ—ó fallback –∫–æ–¥—É:**
- `orchestrator/workflow/executor-v3.js` - `fallbackChatResponse()` (5+ –≤–∏–∫–ª–∏–∫—ñ–≤)
- `orchestrator/ai/fallback-llm.js` - –ª–æ–∫–∞–ª—å–Ω–∏–π LLM fallback
- `orchestrator/ai/state-analyzer.js` - `localFallbackAnalysis()`
- `orchestrator/errors/error-handler.js` - fallback agent handling
- `orchestrator/agents/goose-client.js` - –ù–ï –º–∞—î fallback (–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ü—Ä–∏ –Ω–∞–π–º–µ–Ω—à—ñ–π –ø—Ä–æ–±–ª–µ–º—ñ —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ fallback
- Fallback –Ω–µ –º–∞—î –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Å–µ—Å—ñ—ó
- Fallback –≥–µ–Ω–µ—Ä—É—î —à–∞–±–ª–æ–Ω–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –∑ –ø—Ä–æ–º–ø—Ç—ñ–≤

### 2.2 –ü—Ä–æ–±–ª–µ–º–∞ #2: –ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –º—ñ–∂ –µ—Ç–∞–ø–∞–º–∏

**–§–∞–π–ª:** `orchestrator/workflow/executor-v3.js`

```javascript
// –ü–æ—Ç–æ—á–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è:
const stageResponse = await executeConfiguredStage(stageConfig, userMessage, session, res);

// session.history —î, –∞–ª–µ –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö!
// –ö–æ–∂–µ–Ω –µ—Ç–∞–ø –±–∞—á–∏—Ç—å –¢–Ü–õ–¨–ö–ò userMessage, –Ω–µ —ñ—Å—Ç–æ—Ä—ñ—é
```

**–í–∏—è–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞:**
- –°–µ—Å—ñ—è `session.history` –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è
- –ê–ª–µ —ñ—Å—Ç–æ—Ä—ñ—è –ù–ï –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ –ø—Ä–æ–º–ø—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤
- –ö–æ–∂–µ–Ω –≤–∏–∫–ª–∏–∫ –∞–≥–µ–Ω—Ç–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è "–∑ –Ω—É–ª—è"

### 2.3 –ü—Ä–æ–±–ª–µ–º–∞ #3: –ú–Ω–æ–∂–∏–Ω–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π

**–ù–∞—è–≤–Ω—ñ —Å–∏—Å—Ç–µ–º–∏:**
1. `config/global-config.js` - —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ (–ü–†–ê–í–ò–õ–¨–ù–ê)
2. `orchestrator/config.js` - –ª–æ–∫–∞–ª—å–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (–î–£–ë–õ–Ü–ö–ê–¢)
3. `shared-config.js` (root) - –∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π —Ñ–∞–π–ª
4. `web/static/js/shared-config.js` - frontend config
5. `config/api-config.js`, `agents-config.js`, `workflow-config.js` - –º–æ–¥—É–ª—å–Ω—ñ

**–ü—Ä–æ–±–ª–µ–º–∏:**
- –†—ñ–∑–Ω—ñ —á–∞—Å—Ç–∏–Ω–∏ —Å–∏—Å—Ç–µ–º–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —Ä—ñ–∑–Ω—ñ –∫–æ–Ω—Ñ—ñ–≥–∏
- –ù–µ–º–∞—î –≥–∞—Ä–∞–Ω—Ç—ñ—ó —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó
- –°–∫–ª–∞–¥–Ω–æ –≤—ñ–¥—Å—Ç–µ–∂–∏—Ç–∏ –∑–≤—ñ–¥–∫–∏ –±–µ—Ä–µ—Ç—å—Å—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### 2.4 –ü—Ä–æ–±–ª–µ–º–∞ #4: Stage-based workflow –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—î chat mode

**–§–∞–π–ª:** `config/workflow-config.js`

```javascript
{
  stage: 0,
  agent: 'atlas',
  name: 'stage0_chat',
  description: 'Atlas –≤ —Ä–µ–∂–∏–º—ñ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ API 4000',
  required: false,
  condition: 'system_selected_chat',
  maxRetries: 0,
  timeout: 30000,
  expectedStates: ['chat_response']
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Stage 0 –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –¥–ª—è –ö–û–ñ–ù–û–ì–û –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- –ù–µ–º–∞—î "conversation continuation" –ª–æ–≥—ñ–∫–∏
- –ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è

---

## 3. –î–ï–¢–ê–õ–¨–ù–ê –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê WORKFLOW

### 3.1 –ü–æ—Ç–æ—á–Ω–∏–π workflow –¥–ª—è chat mode

```
[USER MESSAGE] 
    ‚Üì
[Stage 0: Mode Selection - SYSTEM]
    ‚Üí –í–∏–∑–Ω–∞—á–∞—î: chat –∞–±–æ task
    ‚Üì
[Stage 0: Chat - ATLAS —á–µ—Ä–µ–∑ Goose]
    ‚Üí –û—Ç—Ä–∏–º—É—î –¢–Ü–õ–¨–ö–ò userMessage
    ‚Üí –ù–ï –æ—Ç—Ä–∏–º—É—î session.history
    ‚Üí –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑ –ø—Ä–æ–º–ø—Ç—É –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
    ‚Üì
[Response –Ω–∞–¥—Å–∏–ª–∞—î—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É]
```

**–í—ñ–¥—Å—É—Ç–Ω—è –ª–æ–≥—ñ–∫–∞:**
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —Ü–µ –ü–ï–†–®–ï –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —á–∏ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è
- –ü–µ—Ä–µ–¥–∞—á–∞ —ñ—Å—Ç–æ—Ä—ñ—ó –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞–Ω—É —Ä–æ–∑–º–æ–≤–∏ –º—ñ–∂ –≤–∏–∫–ª–∏–∫–∞–º–∏

### 3.2 –Ø–∫ –ú–ê–Ñ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ chat mode

```
[USER MESSAGE]
    ‚Üì
[–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: —á–∏ —î session.history?]
    ‚Üí –Ø–∫—â–æ EMPTY: —Ü–µ –Ω–æ–≤–∞ —Ä–æ–∑–º–æ–≤–∞
    ‚Üí –Ø–∫—â–æ NOT EMPTY: –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è —Ä–æ–∑–º–æ–≤–∏
    ‚Üì
[–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É]
    ‚Üí –ó–±—ñ—Ä –æ—Å—Ç–∞–Ω–Ω—ñ—Ö N –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ session.history
    ‚Üí –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –≤ messages array
    ‚Üì
[Atlas —á–µ—Ä–µ–∑ Goose + –ü–û–í–ù–ò–ô –ö–û–ù–¢–ï–ö–°–¢]
    ‚Üí messages: [—ñ—Å—Ç–æ—Ä—ñ—è + –Ω–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è]
    ‚Üí –ö–æ–Ω—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
    ‚Üì
[–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ session.history]
    ‚Üì
[Response –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É]
```

---

## 4. GOOSE CLIENT - –Ñ–î–ò–ù–ê –ü–†–ê–í–ò–õ–¨–ù–ê –†–ï–ê–õ–Ü–ó–ê–¶–Ü–Ø

**–§–∞–π–ª:** `orchestrator/agents/goose-client.js`

```javascript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - –ù–ï –º–∞—î fallback
export async function callGooseAgent(prompt, baseSessionId, options = {}) {
  try {
    const result = await callGooseWebSocket(gooseBaseUrl, truncatedMessage, sessionId);
    
    if (result && result.trim().length > 0) {
      return result;
    }
    
    // –Ø–∫—â–æ Goose –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–≤ - —Ü–µ –ø–æ–º–∏–ª–∫–∞, –Ω–µ fallback
    console.error('[GOOSE] Did not provide response - NO FALLBACK');
    return null;
  } catch (error) {
    console.error(`[GOOSE] Call failed: ${error.message} - NO FALLBACK`);
    return null;
  }
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ —Ü—å–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É:**
- –ù–µ –º–∞—Å–∫—É—î —Ä–µ–∞–ª—å–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏
- –ü–æ–≤–µ—Ä—Ç–∞—î `null` –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ (–º–æ–∂–Ω–∞ –æ–±—Ä–æ–±–∏—Ç–∏ –≤–∏—â–µ)
- –ù–µ –≥–µ–Ω–µ—Ä—É—î —Ñ–µ–π–∫–æ–≤—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

---

## 5. PROMPTS –°–ò–°–¢–ï–ú–ê - –Ø–ö –ú–ê–Ñ –ü–†–ê–¶–Æ–í–ê–¢–ò

### 5.1 –ü–æ—Ç–æ—á–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–º–ø—Ç—ñ–≤

```
prompts/
‚îú‚îÄ‚îÄ atlas/
‚îÇ   ‚îú‚îÄ‚îÄ role_base.mjs          # –ë–∞–∑–æ–≤–∞ —Ä–æ–ª—å
‚îÇ   ‚îú‚îÄ‚îÄ chat_mode.mjs          # –†–µ–∂–∏–º —á–∞—Ç—É
‚îÇ   ‚îî‚îÄ‚îÄ task_mode.mjs          # –†–µ–∂–∏–º –∑–∞–≤–¥–∞–Ω—å
‚îú‚îÄ‚îÄ tetyana/
‚îú‚îÄ‚îÄ grisha/
‚îî‚îÄ‚îÄ system/
    ‚îî‚îÄ‚îÄ state_analysis_prompts.mjs  # –ú—ñ—Å—Ç–∏—Ç—å FALLBACK_ANALYSIS_RULES
```

### 5.2 –ü—Ä–æ–±–ª–µ–º–∞ –∑ –ø—Ä–æ–º–ø—Ç–∞–º–∏

**–§–∞–π–ª:** `prompts/system/state_analysis_prompts.mjs`

```javascript
export const FALLBACK_ANALYSIS_RULES = {
  // –¶—ñ –ø—Ä–∞–≤–∏–ª–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –∫–æ–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
  // –ù–û –≤–æ–Ω–∏ –ù–ï –º–∞—é—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Å–µ—Å—ñ—ó!
}
```

**–í–∏—è–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞:**
- Fallback –ø—Ä–∞–≤–∏–ª–∞ –∂–æ—Ä—Å—Ç–∫–æ –∑–∞–∫–æ–¥–æ–≤–∞–Ω—ñ
- –ù–µ –º–∞—é—Ç—å –¥–æ—Å—Ç—É–ø—É –¥–æ `session.history`
- –ì–µ–Ω–µ—Ä—É—é—Ç—å –∑–∞–≥–∞–ª—å–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

### 5.3 –Ø–∫ –º–∞—î –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–ø—Ç—ñ–≤

```javascript
// ‚ùå –ü–û–¢–û–ß–ù–ê –†–ï–ê–õ–Ü–ó–ê–¶–Ü–Ø
const prompt = CHAT_PROMPTS.base; // –°—Ç–∞—Ç–∏—á–Ω–∏–π –ø—Ä–æ–º–ø—Ç
const response = await callGooseAgent(prompt, sessionId);

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê –†–ï–ê–õ–Ü–ó–ê–¶–Ü–Ø
const contextMessages = buildContextFromHistory(session.history, {
  maxMessages: 10,
  includeSystem: true
});

const fullPrompt = {
  system: CHAT_PROMPTS.system_role,
  messages: [
    ...contextMessages,
    { role: 'user', content: userMessage }
  ]
};

const response = await callGooseAgent(fullPrompt, sessionId);
```

---

## 6. –ö–†–ò–¢–ò–ß–ù–Ü –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø (–ü–†–Ü–û–†–ò–¢–ï–¢–ò)

### üî¥ –ü–†–Ü–û–†–ò–¢–ï–¢ 1: –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ fallback –º–µ—Ö–∞–Ω—ñ–∑–º–∏

**–§–∞–π–ª–∏ –¥–ª—è –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:**
1. `orchestrator/workflow/executor-v3.js`
   - –í–∏–¥–∞–ª–∏—Ç–∏ `fallbackChatResponse()`
   - –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –≤–∏–∫–ª–∏–∫–∏ fallback
   
2. `orchestrator/ai/fallback-llm.js`
   - ‚ùì –ó–∞–ª–∏—à–∏—Ç–∏ –¢–Ü–õ–¨–ö–ò –¥–ª—è stage -3 (TTS optimization)
   - –í–∏–¥–∞–ª–∏—Ç–∏ –∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ workflow
   
3. `orchestrator/ai/state-analyzer.js`
   - –í–∏–¥–∞–ª–∏—Ç–∏ `localFallbackAnalysis()`
   - –ü—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ - throw exception, –Ω–µ fallback

### üî¥ –ü–†–Ü–û–†–ò–¢–ï–¢ 2: –í–ø—Ä–æ–≤–∞–¥–∏—Ç–∏ –ø–µ—Ä–µ–¥–∞—á—É –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

**–ó–º—ñ–Ω–∏ –≤ `orchestrator/workflow/stages/agent-stage-processor.js`:**

```javascript
async execute(userMessage, session, res, options = {}) {
  // –ë—É–¥—É—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑ —ñ—Å—Ç–æ—Ä—ñ—ó
  const contextMessages = this.buildContextMessages(session);
  
  // –ü–µ—Ä–µ–¥–∞—î–º–æ –≤ Goose
  const response = await callGooseAgent({
    messages: contextMessages,
    newMessage: userMessage
  }, session.id, { agent: this.agent });
}

buildContextMessages(session) {
  const messages = [];
  
  // –î–æ–¥–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç
  messages.push({
    role: 'system',
    content: this.getSystemPrompt()
  });
  
  // –î–æ–¥–∞—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ N –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ —ñ—Å—Ç–æ—Ä—ñ—ó
  const recentHistory = session.history.slice(-10); // –û—Å—Ç–∞–Ω–Ω—ñ 10
  for (const msg of recentHistory) {
    if (msg.role === 'user' || msg.role === 'assistant') {
      messages.push({
        role: msg.role,
        content: msg.content
      });
    }
  }
  
  return messages;
}
```

### üü° –ü–†–Ü–û–†–ò–¢–ï–¢ 3: –£–Ω—ñ—Ñ—ñ–∫—É–≤–∞—Ç–∏ —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π

**–ü–ª–∞–Ω –¥—ñ–π:**
1. –ó–∞–ª–∏—à–∏—Ç–∏ –¢–Ü–õ–¨–ö–ò `config/global-config.js` —è–∫ —î–¥–∏–Ω–µ –¥–∂–µ—Ä–µ–ª–æ
2. –í–∏–¥–∞–ª–∏—Ç–∏ `orchestrator/config.js` (–¥—É–±–ª—ñ–∫–∞—Ç)
3. –í–∏–¥–∞–ª–∏—Ç–∏ `shared-config.js` (–∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–π)
4. –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ frontend —á–µ—Ä–µ–∑ `config/sync-configs.js`

### üü° –ü–†–Ü–û–†–ò–¢–ï–¢ 4: –í–∏–ø—Ä–∞–≤–∏—Ç–∏ chat mode workflow

**–ó–º—ñ–Ω–∏ –≤ `config/workflow-config.js`:**

```javascript
{
  stage: 0,
  agent: 'atlas',
  name: 'stage0_chat_continuation',
  description: 'Atlas –≤ —Ä–µ–∂–∏–º—ñ –ü–†–û–î–û–í–ñ–ï–ù–ù–Ø —Ä–æ–∑–º–æ–≤–∏',
  required: false,
  condition: 'system_selected_chat_and_has_history',
  contextMode: 'full_history', // –ù–û–í–ò–ô –ü–ê–†–ê–ú–ï–¢–†
  maxRetries: 0,
  timeout: 30000,
  expectedStates: ['chat_response']
}
```

---

## 7. –¢–ï–°–¢–û–í–ò–ô –ü–õ–ê–ù

### 7.1 –¢–µ—Å—Ç #1: –ë–∞–∑–æ–≤–µ —É—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

```
[USER] –ü—Ä–∏–≤—ñ—Ç, –º–µ–Ω–µ –∑–≤–∞—Ç–∏ –ü–µ—Ç—Ä–æ
[ATLAS] –ü—Ä–∏–≤—ñ—Ç, –ü–µ—Ç—Ä–æ! –†–∞–¥–∏–π –ø–æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è...

[USER] –Ø–∫ –º–µ–Ω–µ –∑–≤–∞—Ç–∏?
[ATLAS] –í–∞—Å –∑–≤–∞—Ç–∏ –ü–µ—Ç—Ä–æ. // ‚úÖ –ü–∞–º'—è—Ç–∞—î –∫–æ–Ω—Ç–µ–∫—Å—Ç
```

### 7.2 –¢–µ—Å—Ç #2: –ë–∞–≥–∞—Ç–æ–∫—Ä–æ–∫–æ–≤–∞ —Ä–æ–∑–º–æ–≤–∞

```
[USER] –†–æ–∑–∫–∞–∂–∏ –ø—Ä–æ —Å–µ–±–µ
[ATLAS] –Ø ‚Äî –ê—Ç–ª–∞—Å, –≤–∞—à —Ü–∏—Ñ—Ä–æ–≤–∏–π –ø–æ–º—ñ—á–Ω–∏–∫...

[USER] –ê —â–æ —Ç–∏ –º–æ–∂–µ—à —Ä–æ–±–∏—Ç–∏?
[ATLAS] –Ø–∫ —è –≤–∂–µ –∑–≥–∞–¥—É–≤–∞–≤, —è –º–æ–∂—É... // ‚úÖ –ü–æ—Å–∏–ª–∞—î—Ç—å—Å—è –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—î

[USER] –†–æ–∑–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç
[ATLAS] –ó–≤—ñ—Å–Ω–æ! –û—Å—å –∞–Ω–µ–∫–¥–æ—Ç: ... // ‚úÖ –ù–ï –ø–æ–≤—Ç–æ—Ä—é—î –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è
```

### 7.3 –¢–µ—Å—Ç #3: –ë–µ–∑ fallback

```javascript
// –°–∏–º—É–ª—è—Ü—ñ—è –ø–æ–º–∏–ª–∫–∏ Goose
await callGooseAgent(prompt, sessionId); // ‚Üí throws error

// –û—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞:
// ‚ùå –ù–ï –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ fallback –≤—ñ–¥–ø–æ–≤—ñ–¥—å
// ‚úÖ –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
// ‚úÖ –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø—ñ–∑–Ω—ñ—à–µ
```

---

## 8. –ê–†–•–Ü–¢–ï–ö–¢–£–†–ê "–°–¢–ê–ñ–ï" –°–ò–°–¢–ï–ú–ò

### 8.1 –©–æ —Ç–∞–∫–µ "—Å—Ç–∞–∂–µ"?

**–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** Stage-based workflow —Å–∏—Å—Ç–µ–º–∞ –¥–µ –∫–æ–∂–µ–Ω –µ—Ç–∞–ø (stage) –º–∞—î:
- –ß—ñ—Ç–∫–æ –≤–∏–∑–Ω–∞—á–µ–Ω—É —Ä–æ–ª—å
- –í—Ö—ñ–¥–Ω—ñ —Ç–∞ –≤–∏—Ö—ñ–¥–Ω—ñ —É–º–æ–≤–∏
- –ó–≤'—è–∑–æ–∫ –∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –∞–≥–µ–Ω—Ç–æ–º
- –ü—Ä–æ–º–ø—Ç –∑ `prompts/` –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó

### 8.2 –ü—Ä–∞–≤–∏–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞ –∑—ñ —Å—Ç–∞–∂–∞–º–∏

```javascript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Å—Ç–∞–∂ –∑ fallback
async function executeStage(stage, input) {
  try {
    const result = await callAgent(stage.agent, input);
    return result;
  } catch (error) {
    // Fallback –º–∞—Å–∫—É—î –ø—Ä–æ–±–ª–µ–º—É
    return generateFallbackResponse();
  }
}

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û - —Å—Ç–∞–∂ –±–µ–∑ fallback
async function executeStage(stage, input, session) {
  const prompt = await promptRegistry.get(stage.agent, stage.name);
  const context = buildContext(session);
  
  const result = await callAgent(stage.agent, {
    prompt,
    context,
    input
  });
  
  if (!result) {
    throw new StageExecutionError(
      `Stage ${stage.name} failed - no response from ${stage.agent}`
    );
  }
  
  return result;
}
```

---

## 9. –ñ–ò–í–Ü –ü–†–û–ú–ü–¢–ò - –°–ò–°–¢–ï–ú–ê –ë–ï–ó –•–ê–†–î–ö–û–î–£

### 9.1 –ü–æ—Ç–æ—á–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞

```javascript
// ‚ùå –ü—Ä–æ–º–ø—Ç –∑–∞—Ö–∞—Ä–¥–∫–æ–¥–∂–µ–Ω–∏–π –≤ –∫–æ–¥—ñ
const fallbackResponse = {
  agent: 'atlas',
  content: '–í—ñ—Ç–∞—é! –Ø ‚Äî –ê—Ç–ª–∞—Å, —Ü–∏—Ñ—Ä–æ–≤–µ –≤—Ç—ñ–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ–ª–µ–∫—Ç—É...',
  ...
};
```

### 9.2 –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥ - –∂–∏–≤—ñ –ø—Ä–æ–º–ø—Ç–∏

```javascript
// ‚úÖ –ü—Ä–æ–º–ø—Ç –∑ —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏
const prompt = await promptRegistry.get('atlas', 'chat_greeting');

// ‚úÖ –ü—Ä–æ–º–ø—Ç –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
const renderedPrompt = await promptRegistry.render('atlas', 'chat_mode', {
  userName: session.user?.name || '–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á',
  conversationHistory: session.history,
  currentTopic: session.meta?.topic
});
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ü—Ä–æ–º–ø—Ç–∏ –º–æ–∂–Ω–∞ –º—ñ–Ω—è—Ç–∏ –±–µ–∑ –∑–º—ñ–Ω–∏ –∫–æ–¥—É
- –í–µ—Ä—Å—ñ–æ–Ω—É–≤–∞–Ω–Ω—è –ø—Ä–æ–º–ø—Ç—ñ–≤
- A/B —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ä—ñ–∑–Ω–∏—Ö –ø—Ä–æ–º–ø—Ç—ñ–≤
- –õ–µ–≥–∫–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è personality –∞–≥–µ–Ω—Ç—ñ–≤

---

## 10. –ü–õ–ê–ù –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–£

### –§–∞–∑–∞ 1: –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞ –æ—á–∏—â–µ–Ω–Ω—è (1-2 –≥–æ–¥–∏–Ω–∏)
- ‚úÖ –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ü–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –∞–Ω–∞–ª—ñ–∑—É
- ‚è≥ –í–∏–¥–∞–ª–∏—Ç–∏ fallback –∑ `executor-v3.js`
- ‚è≥ –í–∏–¥–∞–ª–∏—Ç–∏ fallback –∑ `state-analyzer.js`
- ‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–µ —â–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è fallback

### –§–∞–∑–∞ 2: –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (2-3 –≥–æ–¥–∏–Ω–∏)
- ‚è≥ –ú–æ–¥–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ `agent-stage-processor.js`
- ‚è≥ –î–æ–¥–∞—Ç–∏ `buildContextMessages()` –º–µ—Ç–æ–¥
- ‚è≥ –û–Ω–æ–≤–∏—Ç–∏ –≤–∏–∫–ª–∏–∫–∏ `callGooseAgent()`
- ‚è≥ –¢–µ—Å—Ç—É–≤–∞—Ç–∏ –ø–µ—Ä–µ–¥–∞—á—É —ñ—Å—Ç–æ—Ä—ñ—ó

### –§–∞–∑–∞ 3: –£–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π (1 –≥–æ–¥–∏–Ω–∞)
- ‚è≥ –í–∏–¥–∞–ª–∏—Ç–∏ –¥—É–±–ª—å–æ–≤–∞–Ω—ñ config —Ñ–∞–π–ª–∏
- ‚è≥ –ü–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è —â–æ –≤—Å—ñ –º–æ–¥—É–ª—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `global-config.js`
- ‚è≥ –û–Ω–æ–≤–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—é

### –§–∞–∑–∞ 4: –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è chat workflow (1-2 –≥–æ–¥–∏–Ω–∏)
- ‚è≥ –î–æ–¥–∞—Ç–∏ —É–º–æ–≤—É –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è —Ä–æ–∑–º–æ–≤–∏
- ‚è≥ –†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ä–æ–∑—Ä—ñ–∑–Ω–µ–Ω–Ω—è "–Ω–æ–≤–∞ —Ä–æ–∑–º–æ–≤–∞" vs "–ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è"
- ‚è≥ –¢–µ—Å—Ç—É–≤–∞—Ç–∏ –±–∞–≥–∞—Ç–æ–∫—Ä–æ–∫–æ–≤—ñ –¥—ñ–∞–ª–æ–≥–∏

### –§–∞–∑–∞ 5: –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è (1 –≥–æ–¥–∏–Ω–∞)
- ‚è≥ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É
- ‚è≥ –ü—Ä–æ–π—Ç–∏ –≤—Å—ñ —Ç–µ—Å—Ç–∏ –∑ —Ä–æ–∑–¥—ñ–ª—É 7
- ‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å fallback –≤–∏–∫–ª–∏–∫—ñ–≤
- ‚è≥ –í–∞–ª—ñ–¥—É–≤–∞—Ç–∏ —â–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è

---

## 11. –û–ß–Ü–ö–£–í–ê–ù–Ü –†–ï–ó–£–õ–¨–¢–ê–¢–ò

### –î–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É (–ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω):
```
[USER] –ü—Ä–∏–≤—ñ—Ç
[ATLAS] –í—ñ—Ç–∞—é! –Ø ‚Äî –ê—Ç–ª–∞—Å...

[USER] –Ø–∫ —Å–ø—Ä–∞–≤–∏?
[ATLAS] –í—ñ—Ç–∞—é! –Ø ‚Äî –ê—Ç–ª–∞—Å... // ‚ùå –ü–æ–≤—Ç–æ—Ä—é—î –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è
```

### –ü—ñ—Å–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É (–æ—á—ñ–∫—É–≤–∞–Ω–∏–π —Å—Ç–∞–Ω):
```
[USER] –ü—Ä–∏–≤—ñ—Ç
[ATLAS] –ü—Ä–∏–≤—ñ—Ç! –†–∞–¥–∏–π –≤–∞—Å –±–∞—á–∏—Ç–∏. –Ø–∫ —è –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?

[USER] –Ø–∫ —Å–ø—Ä–∞–≤–∏?
[ATLAS] –£ –º–µ–Ω–µ –≤—Å–µ —á—É–¥–æ–≤–æ, –¥—è–∫—É—é –∑–∞ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è! –ê —É –≤–∞—Å —è–∫?

[USER] –†–æ–∑–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç
[ATLAS] –ó —Ä–∞–¥—ñ—Å—Ç—é! –û—Å—å –¥–æ–±—Ä–∏–π –∞–Ω–µ–∫–¥–æ—Ç –ø—Ä–æ –ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç—ñ–≤...
```

---

## 12. –ú–ï–¢–†–ò–ö–ò –£–°–ü–Ü–•–£

1. **–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ç—Ä–∏–º—É—î—Ç—å—Å—è:** >= 95% –≤–∏–ø–∞–¥–∫—ñ–≤ —É –±–∞–≥–∞—Ç–æ–∫—Ä–æ–∫–æ–≤–∏—Ö –¥—ñ–∞–ª–æ–≥–∞—Ö
2. **Fallback –≤–∏–∫–ª–∏–∫—ñ–≤:** 0 –≤ chat mode
3. **–ß–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:** < 3 —Å–µ–∫—É–Ω–¥–∏ –¥–ª—è chat mode
4. **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π:** –Ø–∫—ñ—Å–Ω–∞ –æ—Ü—ñ–Ω–∫–∞ –ø–æ–∫—Ä–∞—â–∏–ª–∞—Å—å

---

## 13. –†–ò–ó–ò–ö–ò –¢–ê MITIGATION

### –†–∏–∑–∏–∫ #1: Goose –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î conversation history
**Mitigation:** –ü–µ—Ä–µ–¥–∞–≤–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —è–∫ —á–∞—Å—Ç–∏–Ω—É –ø—Ä–æ–º–ø—Ç—É

### –†–∏–∑–∏–∫ #2: –ù–∞–¥—Ç–æ –¥–æ–≤–≥–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–≤–∏—â—É—î –ª—ñ–º—ñ—Ç–∏
**Mitigation:** –û–±–º–µ–∂–µ–Ω–Ω—è –¥–æ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 10 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å + smart truncation

### –†–∏–∑–∏–∫ #3: –ü–æ—Ä—É—à–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ task workflow
**Mitigation:** –ó–º—ñ–Ω–∏ –¢–Ü–õ–¨–ö–ò –≤ chat mode, task mode –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –Ω–µ–∑–º—ñ–Ω–Ω–∏–º

---

## –í–ò–°–ù–û–í–û–ö

–°–∏—Å—Ç–µ–º–∞ –º–∞—î **–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏** –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —Ç–∞ –Ω–∞–¥–º—ñ—Ä–Ω–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é fallback –º–µ—Ö–∞–Ω—ñ–∑–º—ñ–≤. –†—ñ—à–µ–Ω–Ω—è –ø–æ–ª—è–≥–∞—î –≤:

1. **–í–∏–¥–∞–ª–µ–Ω–Ω—ñ –≤—Å—ñ—Ö fallback** (–∫—Ä—ñ–º –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –≤–∏–ø–∞–¥–∫—ñ–≤)
2. **–í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—ñ –ø–µ—Ä–µ–¥–∞—á—ñ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É** —á–µ—Ä–µ–∑ `session.history`
3. **–£–Ω—ñ—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π** –¥–æ —î–¥–∏–Ω–æ–≥–æ `global-config.js`
4. **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—ñ chat workflow** –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è —Ä–æ–∑–º–æ–≤

–ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫: **–ø–æ–∫—Ä–æ–∫–æ–≤–∏–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥** –∑ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è–º –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ—Ç–∞–ø—É.
