# –ê–Ω–∞–ª—ñ–∑ –ø—Ä–æ–±–ª–µ–º–∏ Conversation Mode - 11.10.2025

## üîç –ü—Ä–æ–±–ª–µ–º–∞

**–°–∏–º–ø—Ç–æ–º:** –î—Ä—É–≥–∏–π —Ä–µ–∂–∏–º (Conversation Mode) –ù–ï —Ä–µ–∞–≥—É—î –Ω–∞ —Å–ª–æ–≤–æ "–ê—Ç–ª–∞—Å" - –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó —Å–∏—Å—Ç–µ–º–∏ –ø—ñ—Å–ª—è —É—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ 2+ —Å–µ–∫—É–Ω–¥–∏.

**–û—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞:**
1. –£—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ 2+ —Å–µ–∫—É–Ω–¥–∏ ‚Üí –∞–∫—Ç–∏–≤–∞—Ü—ñ—è Conversation Mode
2. –°–∏—Å—Ç–µ–º–∞ —Å–ª—É—Ö–∞—î –∫–ª—é—á–æ–≤–µ —Å–ª–æ–≤–æ "–ê—Ç–ª–∞—Å"
3. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–∞–∂–µ "–ê—Ç–ª–∞—Å"
4. –°–∏—Å—Ç–µ–º–∞ –≤–∏–ø–∞–¥–∫–æ–≤–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –æ–¥–Ω–∏–º –∑ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤: "–°–ª—É—Ö–∞—é", "–°–ª—É—Ö–∞—é —Ç–µ–±–µ", "–¢–∞–∫", "–ì–æ—Ç–æ–≤–∏–π", etc.
5. –°–∏—Å—Ç–µ–º–∞ –∑–∞–ø–∏—Å—É—î –∑–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
6. –í—ñ–¥–ø—Ä–∞–≤–ª—è—î –≤ chat mode (stage 0)
7. Atlas –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —á–µ—Ä–µ–∑ TTS
8. –ü—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:
   - –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–æ–¥–æ–≤–∂—É—î –≥–æ–≤–æ—Ä–∏—Ç–∏ ‚Üí —Ü–∏–∫–ª—ñ—á–Ω–∞ —Ä–æ–∑–º–æ–≤–∞
   - –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–≤—á–∏—Ç—å ‚Üí –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è "–ê—Ç–ª–∞—Å"
   - –Ø–∫—â–æ –ø–µ—Ä–µ–π—à–ª–æ –≤ task mode ‚Üí —ñ–Ω—à–∞ —Å–∏—Å—Ç–µ–º–∞ –∑—É–ø–∏–Ω–∫–∏ (stop commands)

**–§–∞–∫—Ç–∏—á–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞:**
- –†–µ–∂–∏–º Quick-send (–ø–µ—Ä—à–∏–π) –ø—Ä–∞—Ü—é—î –∫–æ—Ä–µ–∫—Ç–Ω–æ
- Conversation Mode –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –≤—ñ–∑—É–∞–ª—å–Ω–æ, –∞–ª–µ –ù–ï —Ä–µ–∞–≥—É—î –Ω–∞ "–ê—Ç–ª–∞—Å"

---

## üî¨ –¢–µ—Ö–Ω—ñ—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤

```bash
tail -100 logs/orchestrator.log | grep -i "conversation\|keyword\|atlas\|–∞—Ç–ª–∞—Å"
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¢–Ü–õ–¨–ö–ò –∑–∞–ø–∏—Å–∏ –ø—Ä–æ Quick-send mode, –∂–æ–¥–Ω–∏—Ö –∑–≥–∞–¥–æ–∫ –ø—Ä–æ conversation mode
```

```bash
tail -100 logs/whisper.log | grep -i "keyword\|detect\|atlas\|–∞—Ç–ª–∞—Å"  
# –†–µ–∑—É–ª—å—Ç–∞—Ç: –¢—ñ–ª—å–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó Whisper, –±–µ–∑ keyword detection
```

**–í–∏—Å–Ω–æ–≤–æ–∫ –∑ –ª–æ–≥—ñ–≤:**
- Conversation Mode –ù–ï –ª–æ–≥—É—î—Ç—å—Å—è –≤ orchestrator
- Keyword detection –ù–ï —Å–ø—Ä–∞—Ü—å–æ–≤—É—î
- –°–æ–±—ã—Ç–∏—è `KEYWORD_DETECTED` –ù–ï –µ–º—ñ—Ç—É—é—Ç—å—Å—è

---

### –ê–Ω–∞–ª—ñ–∑ –∫–æ–¥—É

#### ‚úÖ Quick-send —Ä–µ–∂–∏–º (–ø—Ä–∞—Ü—é—î)

**–ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å:**
```
1. –ö–ª—ñ–∫ –∫–Ω–æ–ø–∫–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
2. ConversationModeManager.handleButtonMouseUp()
3. activateQuickSendMode()
4. emit('CONVERSATION_MODE_QUICK_SEND_START')
5. MicrophoneButtonService.handleQuickSendModeStart()
6. startRecording()
7. Whisper —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±—É—î
8. emit('WHISPER_TRANSCRIPTION_COMPLETED')
9. ConversationModeManager.handleTranscriptionComplete()
10. sendToChat()
```

**–§–∞–π–ª–∏ –∑–∞–¥—ñ—è–Ω—ñ:**
- `conversation-mode-manager.js` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—è
- `microphone-button-service.js` - –∑–∞–ø–∏—Å
- `whisper-service.js` - —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è
- `chat-manager.js` - –≤—ñ–¥–ø—Ä–∞–≤–∫–∞

---

#### ‚ùå Conversation —Ä–µ–∂–∏–º (–ù–ï –ø—Ä–∞—Ü—é—î)

**–û—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å:**
```
1. –£—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ 2+ —Å–µ–∫—É–Ω–¥–∏
2. ConversationModeManager.activateConversationMode()
3. startListeningForKeyword()
4. emit('START_KEYWORD_DETECTION', {keywords: ['–∞—Ç–ª–∞—Å']})
5. KeywordDetectionService –æ—Ç—Ä–∏–º—É—î –ø–æ–¥—ñ—é
6. startDetection() - –∑–∞–ø—É—Å–∫ Web Speech API
7. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–∞–∂–µ "–ê—Ç–ª–∞—Å"
8. Web Speech API —Ä–æ–∑–ø—ñ–∑–Ω–∞—î
9. handleKeywordDetection()
10. emit('KEYWORD_DETECTED')
11. ConversationModeManager.handleKeywordDetected()
12. onKeywordActivation()
13. startConversationRecording()
```

**–î–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ–±–ª–µ–º–∞:**

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ #1: –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ START_KEYWORD_DETECTION

**–§–∞–π–ª:** `keyword-detection-service.js:113-125`

```javascript
subscribeToConversationEvents() {
    // –ó–∞–ø–∏—Ç –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ keyword detection –≤—ñ–¥ conversation mode
    if (this.eventManager) {
      this.eventManager.on('START_KEYWORD_DETECTION', async (event) => {
        const { keywords, mode } = event.payload || {};
        this.logger.info('üîç Received START_KEYWORD_DETECTION request', { keywords, mode });
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è keywords —è–∫—â–æ –ø–µ—Ä–µ–¥–∞–Ω—ñ
        if (keywords && Array.isArray(keywords) && keywords.length > 0) {
          this.detectionConfig.keywords = keywords;
          this.logger.debug(`Updated keywords to: ${keywords.join(', ')}`);
        }
        
        // –ó–∞–ø—É—Å–∫ –¥–µ—Ç–µ–∫—Ü—ñ—ó
        await this.startDetection();
      });
```

**–ü—Ä–æ–±–ª–µ–º–∞:** `this.eventManager` –º–æ–∂–µ –±—É—Ç–∏ undefined!

–ö–æ–¥ **–ù–ï –≥–∞—Ä–∞–Ω—Ç—É—î**, —â–æ eventManager –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—ñ–¥ —á–∞—Å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó.

---

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ #2: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ –µ–º—ñ—Å—ñ—è –ø–æ–¥—ñ—ó

**–§–∞–π–ª:** `conversation-mode-manager.js:360`

```javascript
startListeningForKeyword() {
    this.logger.debug('Started listening for activation keyword');
    this.showConversationStatus('–°–∫–∞–∂—ñ—Ç—å "–ê—Ç–ª–∞—Å" –¥–ª—è –ø–æ—á–∞—Ç–∫—É...');

    // –ï–º—ñ—Å—ñ—è –ø–æ–¥—ñ—ó –¥–ª—è keyword detector
    eventManager.emit(Events.START_KEYWORD_DETECTION, {
      keywords: [this.config.keywordForActivation],
      mode: 'conversation'
    });
  }
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï–º—ñ—Å—ñ—è –ù–ï —á–µ–∫–∞—î –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!

- `eventManager.emit()` - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π –≤–∏–∫–ª–∏–∫
- –Ø–∫—â–æ KeywordDetectionService –ù–ï –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π ‚Üí –ø–æ–¥—ñ—è –≥—É–±–∏—Ç—å—Å—è
- –ù–µ–º–∞—î –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —á–∏ —Ö—Ç–æ—Å—å —Å–ª—É—Ö–∞—î —Ü—é –ø–æ–¥—ñ—é

---

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ #3: –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –ª–æ–≥—É–≤–∞–Ω–Ω—è

**–§–∞–π–ª:** `conversation-mode-manager.js:313-322`

```javascript
async activateConversationMode() {
    clearTimeout(this.longPressTimer);
    this.longPressTimer = null;

    this.currentMode = 'conversation';
    this.isInConversation = true;
    this.conversationActive = true;

    this.logger.info('üí¨ Conversation mode activated');
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥—É–≤–∞–Ω–Ω—è —î, –∞–ª–µ –ù–ï –≤–∏–¥–Ω–æ –≤ orchestrator.log!

–¶–µ –æ–∑–Ω–∞—á–∞—î —â–æ:
- Frontend logger –ù–ï –ø–µ—Ä–µ–¥–∞—î –ª–æ–≥–∏ –≤ orchestrator
- –ê–ë–û –ª–æ–≥–∏ —Ñ—ñ–ª—å—Ç—Ä—É—é—Ç—å—Å—è
- –ê–ë–û logger —Ä—ñ–≤–µ–Ω—å –∑–∞–Ω–∞–¥—Ç–æ –≤–∏—Å–æ–∫–∏–π

---

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ #4: Initialization Order

**–§–∞–π–ª:** BaseService pattern

```javascript
async onInitialize() {
    try {
      // ...
      this.subscribeToConversationEvents();
      // ...
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–æ–∂–ª–∏–≤–∞ —Å–∏—Ç—É–∞—Ü—ñ—è race condition:

1. `ConversationModeManager` —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –ø–µ—Ä—à–∏–º
2. –ï–º—ñ—Ç—É—î `START_KEYWORD_DETECTION`
3. `KeywordDetectionService` —â–µ –ù–ï –ø—ñ–¥–ø–∏—Å–∞–≤—Å—è
4. –ü–æ–¥—ñ—è –≥—É–±–∏—Ç—å—Å—è

---

### üî¥ –ü—Ä–æ–±–ª–µ–º–∞ #5: Web Speech API —Å—Ç–∞–Ω

**–§–∞–π–ª:** `keyword-detection-service.js:166-177`

```javascript
this.recognition.onstart = () => {
      this.isRecognitionRunning = true;
      this.manualStop = false;
      this.logger.info('üé§ Keyword detection started');

      // –°–∫–∏–¥–∞–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤ –ø—Ä–∏ —É—Å–ø—ñ—à–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É
      this.resetErrorCounters();

      this.emit(Events.KEYWORD_DETECTION_STARTED, {
        keywords: this.detectionConfig.keywords
      });
    };
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –Ø–∫—â–æ `recognition.start()` –ù–ï –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è ‚Üí `onstart` –Ω—ñ–∫–æ–ª–∏ –Ω–µ —Å–ø—Ä–∞—Ü—é—î!

–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏:
- –ß–∏ `startDetection()` –≤–∑–∞–≥–∞–ª—ñ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è
- –ß–∏ Web Speech API –¥–æ—Å—Ç—É–ø–Ω–∏–π –≤ –±—Ä–∞—É–∑–µ—Ä—ñ
- –ß–∏ —î –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω

---

## üéØ –ü–ª–∞–Ω –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 1: –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

1. **–î–æ–¥–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ —É—Å—ñ –∫–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏:**
   - `activateConversationMode()` - –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó
   - `startListeningForKeyword()` - –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –µ–º—ñ—Å—ñ—ó
   - `subscribeToConversationEvents()` - –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø—ñ–¥–ø–∏—Å–∫–∏
   - `startDetection()` - –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –∑–∞–ø—É—Å–∫—É Web Speech API

2. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Event Flow:**
   - –î–æ–¥–∞—Ç–∏ –ª–æ–≥–∏ –ü–ï–†–ï–î —ñ –ü–Ü–°–õ–Ø emit
   - –î–æ–¥–∞—Ç–∏ –ª–æ–≥–∏ –ü–ï–†–ï–î —ñ –ü–Ü–°–õ–Ø on
   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ eventManager –æ–¥–∏–Ω –µ–∫–∑–µ–º–ø–ª—è—Ä

3. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Web Speech API:**
   - –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É `navigator.mediaDevices.getUserMedia`
   - –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É `window.SpeechRecognition || window.webkitSpeechRecognition`
   - –õ–æ–≥—É–≤–∞—Ç–∏ –ø–æ–º–∏–ª–∫–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 2: –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ª–æ–≥—ñ–∫–∏

1. **–ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞ –ø—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–æ–¥—ñ—ó:**
   ```javascript
   // BEFORE
   if (this.eventManager) {
     this.eventManager.on('START_KEYWORD_DETECTION', ...)
   }
   
   // AFTER
   if (!this.eventManager) {
     this.logger.error('EventManager not available!');
     return false;
   }
   this.eventManager.on('START_KEYWORD_DETECTION', ...)
   ```

2. **–í–∞–ª—ñ–¥–∞—Ü—ñ—è –µ–º—ñ—Å—ñ—ó:**
   ```javascript
   // BEFORE
   eventManager.emit(Events.START_KEYWORD_DETECTION, {...});
   
   // AFTER
   const emitted = eventManager.emit(Events.START_KEYWORD_DETECTION, {...});
   if (!emitted) {
     this.logger.error('Failed to emit START_KEYWORD_DETECTION');
   }
   this.logger.info('‚úÖ Emitted START_KEYWORD_DETECTION');
   ```

3. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É Web Speech API:**
   ```javascript
   async startDetection() {
     if (this.isRecognitionRunning) {
       this.logger.warn('Recognition already running');
       return true;
     }
     
     if (!this.recognition) {
       this.logger.error('Recognition not initialized!');
       return false;
     }
     
     try {
       this.logger.info('üé§ Starting keyword detection...');
       this.recognition.start();
       this.logger.info('‚úÖ Recognition.start() called successfully');
       return true;
     } catch (error) {
       this.logger.error('Failed to start recognition', null, error);
       return false;
     }
   }
   ```

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 3: Hardcoded responses

**–§–∞–π–ª:** `keyword-detection-service.js`

–î–æ–¥–∞—Ç–∏ –º–µ—Ç–æ–¥ –¥–ª—è –≤–∏–ø–∞–¥–∫–æ–≤–∏—Ö –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π:

```javascript
getRandomActivationResponse() {
  const responses = [
    '–°–ª—É—Ö–∞—é',
    '–°–ª—É—Ö–∞—é —Ç–µ–±–µ',
    '–¢–∞–∫',
    '–ì–æ—Ç–æ–≤–∏–π',
    '–Ø —Ç—É—Ç',
    '–ß–∏–º –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏?',
    '–£–≤–∞–∂–Ω–æ —Å–ª—É—Ö–∞—é'
  ];
  
  const index = Math.floor(Math.random() * responses.length);
  return responses[index];
}
```

–Ü –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏ —á–µ—Ä–µ–∑ TTS:

```javascript
async handleKeywordDetection(transcript, confidence) {
    this.logger.info(`üéØ Keyword detected: "${transcript}" (confidence: ${confidence})`);

    // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –≤–∏–ø–∞–¥–∫–æ–≤–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    const response = this.getRandomActivationResponse();

    // –ï–º—ñ—Å—ñ—è –ø–æ–¥—ñ—ó –≤–∏—è–≤–ª–µ–Ω–Ω—è –∫–ª—é—á–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞
    await this.emit(Events.KEYWORD_DETECTED, {
      transcript,
      confidence,
      response,
      timestamp: new Date(),
      keywords: this.detectionConfig.keywords
    });

    // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤ TTS
    eventManager.emit('PLAY_ACTIVATION_RESPONSE', {
      text: response,
      voice: 'mykyta'
    });

    this.logger.info(`üó£Ô∏è Activation response: "${response}"`);
  }
```

### –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç 4: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

1. **Unit —Ç–µ—Å—Ç–∏ –¥–ª—è –ø–æ–¥—ñ–π:**
   ```javascript
   test('START_KEYWORD_DETECTION emitted and received', async () => {
     const manager = new ConversationModeManager();
     const detector = new KeywordDetectionService();
     
     await manager.initialize();
     await detector.initialize();
     
     let eventReceived = false;
     detector.on('KEYWORD_DETECTION_STARTED', () => {
       eventReceived = true;
     });
     
     manager.startListeningForKeyword();
     
     await sleep(100);
     expect(eventReceived).toBe(true);
   });
   ```

2. **Integration —Ç–µ—Å—Ç:**
   ```javascript
   test('Full conversation flow', async () => {
     // 1. –£—Ç—Ä–∏–º–∞—Ç–∏ –∫–Ω–æ–ø–∫—É 2 —Å–µ–∫
     // 2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–∂–∏–º = conversation
     // 3. –°–∏–º—É–ª—é–≤–∞—Ç–∏ "–ê—Ç–ª–∞—Å"
     // 4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ KEYWORD_DETECTED
     // 5. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ TTS response
     // 6. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å —Ä–æ–∑–ø–æ—á–∞—Ç–æ
   });
   ```

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å

### –ö—Ä–æ–∫ 1: –î–æ–¥–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- [ ] `conversation-mode-manager.js` - –≤—Å—ñ –º–µ—Ç–æ–¥–∏ conversation flow
- [ ] `keyword-detection-service.js` - –≤—Å—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
- [ ] –õ–æ–≥–∏ eventManager emit/on
- [ ] –õ–æ–≥–∏ Web Speech API lifecycle

### –ö—Ä–æ–∫ 2: –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É –Ω–∞ –ø–æ–¥—ñ—ó
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ eventManager –≤ KeywordDetectionService
- [ ] Throw error —è–∫—â–æ eventManager undefined
- [ ] –í–∞–ª—ñ–¥–∞—Ü—ñ—è payload —É subscribeToConversationEvents

### –ö—Ä–æ–∫ 3: –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –µ–º—ñ—Å—ñ—é –ø–æ–¥—ñ–π
- [ ] –î–æ–¥–∞—Ç–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω–Ω—è –∑ emit
- [ ] –õ–æ–≥—É–≤–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç emit
- [ ] –î–æ–¥–∞—Ç–∏ retry –º–µ—Ö–∞–Ω—ñ–∑–º —è–∫—â–æ emit failed

### –ö—Ä–æ–∫ 4: –î–æ–¥–∞—Ç–∏ hardcoded responses
- [ ] –ú–∞—Å–∏–≤ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π "–°–ª—É—Ö–∞—é", "–¢–∞–∫", etc.
- [ ] –ú–µ—Ç–æ–¥ `getRandomActivationResponse()`
- [ ] –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ TTS –¥–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
- [ ] –†–æ—Ç–∞—Ü—ñ—è –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π

### –ö—Ä–æ–∫ 5: –ü–æ–∫—Ä–∞—â–∏—Ç–∏ Web Speech API
- [ ] –î–µ—Ç–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ API
- [ ] Try-catch –Ω–∞–≤–∫–æ–ª–æ recognition.start()
- [ ] –õ–æ–≥—É–≤–∞–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
- [ ] Fallback —è–∫—â–æ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π

### –ö—Ä–æ–∫ 6: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- [ ] Unit —Ç–µ—Å—Ç–∏ –¥–ª—è –ø–æ–¥—ñ–π
- [ ] Integration —Ç–µ—Å—Ç conversation flow
- [ ] Manual —Ç–µ—Å—Ç –∑ —Ä–µ–∞–ª—å–Ω–∏–º –º—ñ–∫—Ä–æ—Ñ–æ–Ω–æ–º
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ —É production

---

## üöÄ –ï—Ç–∞–ø–∏ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### –ï—Ç–∞–ø 1: –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (TODAY)
1. –î–æ–¥–∞—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è
2. –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É
3. –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ conversation mode
4. –ê–Ω–∞–ª—ñ–∑ –ª–æ–≥—ñ–≤ - –¥–µ —Å–∞–º–µ –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è flow

### –ï—Ç–∞–ø 2: –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è core –ø—Ä–æ–±–ª–µ–º–∏ (TODAY)
1. –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –ø—ñ–¥–ø–∏—Å–∫—É –Ω–∞ –ø–æ–¥—ñ—ó
2. –í–∏–ø—Ä–∞–≤–∏—Ç–∏ –µ–º—ñ—Å—ñ—é –ø–æ–¥—ñ–π
3. –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ Web Speech API
4. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –ï—Ç–∞–ø 3: Hardcoded responses (TODAY/TOMORROW)
1. –î–æ–¥–∞—Ç–∏ –º–∞—Å–∏–≤ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π
2. –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ TTS
3. –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ä—ñ–∑–Ω–∏—Ö –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤

### –ï—Ç–∞–ø 4: Full conversation loop (TOMORROW)
1. –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ü–∏–∫–ª—ñ—á–Ω–æ—ó —Ä–æ–∑–º–æ–≤–∏
2. –õ–æ–≥—ñ–∫–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∏—à—ñ
3. –ü–µ—Ä–µ—Ö—ñ–¥ –≤ task mode
4. Stop commands

---

## üìä –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

### –ü–æ—Å–ª–µ –ï—Ç–∞–ø—É 1:
- –¢–æ—á–Ω–µ —Ä–æ–∑—É–º—ñ–Ω–Ω—è –¥–µ –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è flow
- –î–µ—Ç–∞–ª—å–Ω—ñ –ª–æ–≥–∏ –∫–æ–∂–Ω–æ–≥–æ –∫—Ä–æ–∫—É

### –ü–æ—Å–ª–µ –ï—Ç–∞–ø—É 2:
- Conversation mode —É—Å–ø—ñ—à–Ω–æ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è
- Web Speech API —Å–ª—É—Ö–∞—î "–ê—Ç–ª–∞—Å"
- `KEYWORD_DETECTED` –µ–º—ñ—Ç—É—î—Ç—å—Å—è

### –ü–æ—Å–ª–µ –ï—Ç–∞–ø—É 3:
- –ü—Ä–∏ "–ê—Ç–ª–∞—Å" ‚Üí —Å–∏—Å—Ç–µ–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤–∏–ø–∞–¥–∫–æ–≤–æ
- –†—ñ–∑–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –∑–º—ñ–Ω—é—é—Ç—å—Å—è –ø–æ –∫—Ä—É–≥—É
- TTS –æ–∑–≤—É—á—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å

### –ü–æ—Å–ª–µ –ï—Ç–∞–ø—É 4:
- –ü–æ–≤–Ω–∏–π —Ü–∏–∫–ª —Ä–æ–∑–º–æ–≤–∏ –ø—Ä–∞—Ü—é—î
- –ü—ñ—Å–ª—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ Atlas ‚Üí –∑–∞–ø–∏—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- –¶–∏–∫–ª—ñ—á–Ω–∞ —Ä–æ–∑–º–æ–≤–∞ –¥–æ –º–æ–º–µ–Ω—Ç—É —Ç–∏—à—ñ
- –ö–æ—Ä–µ–∫—Ç–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞–∑–∞–¥ –¥–æ keyword listening

---

## üé¨ –í–∏—Å–Ω–æ–≤–æ–∫

**–ö–æ—Ä—ñ–Ω—å –ø—Ä–æ–±–ª–µ–º–∏:** –ù–∞–π—ñ–º–æ–≤—ñ—Ä–Ω—ñ—à–µ –ø–æ—Ä—É—à–µ–Ω–∏–π Event Flow –º—ñ–∂ `ConversationModeManager` —Ç–∞ `KeywordDetectionService`.

**–ö–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:**
1. –ß–∏ `subscribeToConversationEvents()` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è
2. –ß–∏ `eventManager` –¥–æ—Å—Ç—É–ø–Ω–∏–π –≤ KeywordDetectionService
3. –ß–∏ `START_KEYWORD_DETECTION` –µ–º—ñ—Ç—É—î—Ç—å—Å—è
4. –ß–∏ `startDetection()` –∑–∞–ø—É—Å–∫–∞—î Web Speech API
5. –ß–∏ –±—Ä–∞—É–∑–µ—Ä –º–∞—î –¥–æ–∑–≤–æ–ª–∏ –Ω–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω

**–ü—ñ–¥—Ö—ñ–¥ –¥–æ –≤–∏—Ä—ñ—à–µ–Ω–Ω—è:**
1. –°–ø–æ—á–∞—Ç–∫—É –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑ –ª–æ–≥–∞–º–∏
2. –ü–æ—Ç—ñ–º –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è core –ø—Ä–æ–±–ª–µ–º–∏
3. –ü–æ—Ç—ñ–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è features (responses, loop)
4. –í –∫—ñ–Ω—Ü—ñ –ø–æ–≤–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

**–£—Å–ø—ñ—Ö –∫—Ä–∏—Ç–µ—Ä—ñ—ó:**
- –£—Ç—Ä–∏–º–∞–Ω–Ω—è 2 —Å–µ–∫ ‚Üí conversation mode
- –°–ª–æ–≤–æ "–ê—Ç–ª–∞—Å" ‚Üí –≤–∏–ø–∞–¥–∫–æ–≤–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
- –ó–∞–ø–∏—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚Üí –≤—ñ–¥–ø–æ–≤—ñ–¥—å Atlas
- –¶–∏–∫–ª—ñ—á–Ω–∞ —Ä–æ–∑–º–æ–≤–∞ –¥–æ —Ç–∏—à—ñ
