# Видалення Сигнатур Агентів з TTS - Виправлення

**Дата:** 10 жовтня 2025 - пізній вечір  
**Статус:** ✅ ВИПРАВЛЕНО

## Проблема

При озвучці текст містив сигнатури агентів `[ATLAS]`, `[ТЕТЯНА]`, `[ГРИША]`, які зачитувались TTS системою. Це створювало зайве озвучення лейблів, які вже відображаються в інтерфейсі чату.

**Приклад:**
```
TTS озвучує: "[ATLAS] Привіт! Як я можу допомогти вам сьогодні?"
Користувач чує: "Квадратна дужка ATLAS квадратна дужка Привіт! Як я можу..."
```

## Рішення

### 1. Frontend: Видалення сигнатур перед TTS (chat-manager.js)

Додано очищення тексту від сигнатур агентів ПЕРЕД відправкою на TTS:

```javascript
// КРИТИЧНЕ ВИПРАВЛЕННЯ: Видаляємо сигнатури агентів перед TTS
// Щоб не озвучувались лейбели, які вже є в інтерфейсі чату
textForTTS = textForTTS?.replace(/^\[.*?\]\s*/, '').trim();
```

**Місце:** `web/static/js/modules/chat-manager.js`, після визначення `textForTTS`  
**Regex:** `/^\[.*?\]\s*/` - видаляє будь-який текст у квадратних дужках на початку рядка

### 2. Backend: Очищення вже було (agent-stage-processor.js)

Backend вже очищає сигнатури перед відправкою на TTS:

```javascript
// Clean content from agent signature before sending to TTS
const contentForTTS = response.content.replace(/^\[.*?\]\s*/, '').trim();
await sendToTTSAndWait(contentForTTS, voice);
```

**Місце:** `orchestrator/workflow/stages/agent-stage-processor.js`, метод `execute()`

### 3. Додатково: ESLint Cleanup (tts-manager.js)

Виправлено всі ESLint помилки:

- Видалено невикористаний імпорт `VOICE_CONFIG`
- Замінено `catch (_)` на `catch` (без змінної) для всіх блоків
- Додано коментарі в empty catch блоках

**Результат:** ✅ 0 ESLint помилок

## Результат

**ДО:**
```
TTS: "[ATLAS] Привіт! Як я можу допомогти?"
TTS: "[ТЕТЯНА] Зараз відкрию калькулятор..."
TTS: "[ГРИША] Перевіряю виконання завдання..."
```

**ПІСЛЯ:**
```
TTS: "Привіт! Як я можу допомогти?"
TTS: "Зараз відкрию калькулятор..."
TTS: "Перевіряю виконання завдання..."
```

## Технічні Деталі

### Regex Пояснення
```javascript
/^\[.*?\]\s*/
```

- `^` - початок рядка
- `\[` - літеральна квадратна дужка `[`
- `.*?` - будь-які символи (non-greedy)
- `\]` - літеральна квадратна дужка `]`
- `\s*` - необов'язкові пробіли після дужки

### Місця Застосування

1. **Frontend (chat-manager.js):** Очищає text перед `addToQueue()`
2. **Backend (agent-stage-processor.js):** Очищає content перед `sendToTTSAndWait()`

### Переваги Подвійної Очистки

- **Надійність:** Навіть якщо один рівень пропустить, інший підхопить
- **Backward compatibility:** Старий код продовжить працювати
- **Frontend-first:** Користувач не чує сигнатури навіть якщо backend змінився

## Тестування

```bash
# Запустити систему
./restart_system.sh restart

# Перевірити:
# 1. Дати запит у чат
# 2. Переконатись що TTS НЕ озвучує "[ATLAS]" та інші лейбли
# 3. Лейбели мають бути тільки візуально в UI

# Перевірити логи
tail -f logs/orchestrator.log | grep "tts_wait"
# Має показати очищений текст без [ATLAS]
```

## Змінені Файли

1. **web/static/js/modules/chat-manager.js**
   - Додано очищення сигнатур перед TTS
   - Лінія: ~483 (після визначення textForTTS)

2. **web/static/js/modules/tts-manager.js**
   - Видалено VOICE_CONFIG з імпортів
   - Виправлено всі `catch (_)` блоки
   - Додано коментарі в empty catch

3. **orchestrator/workflow/stages/agent-stage-processor.js**
   - Вже було виправлено раніше (TTS sync fix)
   - Очищення сигнатур перед sendToTTSAndWait

---

**Автор:** AI Assistant  
**Дата:** 10 жовтня 2025 - пізній вечір  
**Пов'язано з:** TTS & Workflow Synchronization Fix
