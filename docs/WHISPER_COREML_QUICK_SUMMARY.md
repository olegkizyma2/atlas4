# üîß Whisper Core ML Crash - Quick Fix Summary

**Date:** 13 –∂–æ–≤—Ç–Ω—è 2025, ~01:10-01:30  
**Status:** ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û  
**Severity:** üî¥ CRITICAL (–ø–æ–≤–Ω–∞ –Ω–µ–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó)

---

## üìã –©–æ –±—É–ª–æ –∑–ª–∞–º–∞–Ω–æ

**Quick-send —Ä–µ–∂–∏–º** - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î –∫–Ω–æ–ø–∫—É –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞, –≥–æ–≤–æ—Ä–∏—Ç—å, –∞–ª–µ —Ç–µ–∫—Å—Ç **–ù–ï –∑'—è–≤–ª—è—î—Ç—å—Å—è** –≤ —á–∞—Ç—ñ.

**–ü–æ–º–∏–ª–∫–∞ Stage 1 (Core ML):**
```
whisper_init_state: failed to load Core ML model from 'ggml-large-v3-encoder.mlmodelc'
error: failed to initialize whisper context
```

**–ü–æ–º–∏–ª–∫–∞ Stage 2 (Command Format):**
```
whisper.cpp JSON parse failed. stdout=, stderr=(help menu tail)
Transcription error: whisper.cpp did not produce JSON output
```

---

## üîç –ö–æ—Ä—ñ–Ω—å –ø—Ä–æ–±–ª–µ–º–∏

### –ü—Ä–æ–±–ª–µ–º–∞ #1: Core ML
1. **whisper-cli –Ω–∞–º–∞–≥–∞–≤—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ Core ML** –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
2. **Core ML –º–æ–¥–µ–ª—å –ù–ï —ñ—Å–Ω—É—î** –≤ `models/whisper/`
3. **–ö—Ä–∞—à –ø—Ä–∏ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó** ‚Üí 500 error

### –ü—Ä–æ–±–ª–µ–º–∞ #2: Command Format
1. **Whisper-cli –æ—á—ñ–∫—É—î —Ñ–∞–π–ª –ë–ï–ó `-f`** –≤ –∫—ñ–Ω—Ü—ñ –∫–æ–º–∞–Ω–¥–∏
2. **–ú–∏ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏:** `-f /path/to/file.wav` (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!)
3. **–ú–∞—î –±—É—Ç–∏:** `/path/to/file.wav` (—Ñ–∞–π–ª –æ—Å—Ç–∞–Ω–Ω—ñ–º, –±–µ–∑ -f)
4. **Whisper-cli –ø–æ–∫–∞–∑—É–≤–∞–≤ help** –∑–∞–º—ñ—Å—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—ó

---

## ‚úÖ –®–≤–∏–¥–∫–µ —Ä—ñ—à–µ–Ω–Ω—è

**Fix #1:** –î–æ–¥–∞–Ω–æ `--no-coreml` –¥–ª—è whisper-cli
**Fix #2:** –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥–∏

```python
# BEFORE (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
cmd = [..., '-f', wav_path, ...]

# AFTER (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
is_whisper_cli = 'whisper-cli' in bin_name
if not is_whisper_cli:
    cmd += ['-f', wav_path]  # –°—Ç–∞—Ä–∏–π main –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î -f
    
cmd += ['--no-coreml']  # Fix #1
cmd.append(wav_path)     # Fix #2 - —Ñ–∞–π–ª –æ—Å—Ç–∞–Ω–Ω—ñ–º –¥–ª—è whisper-cli
```

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ **Whisper service –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è** –ë–ï–ó –ø–æ–º–∏–ª–æ–∫ Core ML
- ‚úÖ **Whisper-cli –æ—Ç—Ä–∏–º—É—î –ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–æ–º–∞–Ω–¥—É** (—Ñ–∞–π–ª –≤ –∫—ñ–Ω—Ü—ñ)
- ‚úÖ **–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è –ø—Ä–∞—Ü—é—î** —á–µ—Ä–µ–∑ Metal GPU –Ω–∞–ø—Ä—è–º—É
- ‚úÖ **Quick-send —Ä–µ–∂–∏–º –ø—Ä–∞—Ü—é—î** –∑ –ø–µ—Ä—à–æ–≥–æ —Ä–∞–∑—É

---

## üß™ –Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É: `./restart_system.sh restart`
2. –í—ñ–¥–∫—Ä–∏—Ç–∏ http://localhost:5001
3. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ üé§ ‚Üí —Å–∫–∞–∑–∞—Ç–∏ —â–æ—Å—å ‚Üí –¥–æ—á–µ–∫–∞—Ç–∏—Å—å –∞–≤—Ç–æ—Å—Ç–æ–ø—É
4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ —Ç–µ–∫—Å—Ç –∑'—è–≤–∏–≤—Å—è –≤ —á–∞—Ç—ñ ‚úÖ

**–õ–æ–≥–∏:**
```bash
tail -f logs/whisper.log | grep "Running whisper"
# –ú–∞—î –±—É—Ç–∏: ... --no-coreml /var/folders/.../tmpXXX.wav
# (—Ñ–∞–π–ª –û–°–¢–ê–ù–ù–Ü–ú –±–µ–∑ -f)
```

---

## üìä –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

| –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è | –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è |
|----------------|-------------------|
| Core ML –º–æ–¥–µ–ª—å –ø–æ—Ç—Ä—ñ–±–Ω–∞ ‚ùå | Core ML –ù–ï –ø–æ—Ç—Ä—ñ–±–µ–Ω ‚úÖ |
| 500 error √ó 4 retries | –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è –ø—Ä–∞—Ü—é—î |
| `-f /path/file.wav` ‚ùå | `/path/file.wav` ‚úÖ |
| Whisper-cli –ø–æ–∫–∞–∑—É—î help | Whisper-cli –ø—Ä–∞—Ü—é—î |

---

## ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ù–û

- **Core ML - –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è**, –ù–ï –æ–±–æ–≤'—è–∑–∫–æ–≤–∞
- **Whisper-cli ‚â† main binary** - —Ä—ñ–∑–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥–∏!
- **–§–∞–π–ª –ó–ê–í–ñ–î–ò –æ—Å—Ç–∞–Ω–Ω—ñ–º** –¥–ª—è whisper-cli (–ë–ï–ó `-f`)
- **Metal GPU –ø—Ä–∞—Ü—é—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ** –Ω–∞ Mac M1/M2

---

**–î–µ—Ç–∞–ª—å–Ω–æ:** `docs/WHISPER_COREML_FIX_2025-10-13.md`
