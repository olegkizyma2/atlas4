# ATLAS - Архітектура Системи v4.0
## Adaptive Task and Learning Assistant System - Modular Architecture Edition

---

## 🎯 Загальний опис системи

**ATLAS** - це інтелектуальна система з трьома AI-агентами, що працюють разом для автономного виконання завдань через природний діалог та верифікацію результатів.

### Основні принципи:
- **Modular Architecture** - повністю рефакторена модульна структура
- **Unified Configuration** - єдина конфігурація для всіх компонентів
- **Event-Driven TTS** - синхронізація через реальні події
- **ES6 Modules** - сучасна JavaScript архітектура
- **Prompt-Driven Logic** - вся логіка базується на ролях агентів
- **Безкомпромісне виконання** - система знаходить рішення будь-яким шляхом
- **Живі агенти** - імітація природної людської комунікації
- **Повна автономність** - мінімальне втручання користувача

---

## 🏗 Архітектура системи

```
┌─────────────────────────────────────────────────────────────┐
│                    ATLAS SYSTEM v4.0                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   ATLAS     │◄──►│   TETYANA   │◄──►│   GRISHA    │     │
│  │ Coordinator │    │  Executor   │    │ Verificator │     │
│  │             │    │   (Goose)   │    │             │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                   │                   │          │
│         └───────────────────┼───────────────────┘          │
│                             │                              │
│  ┌─────────────────────────────────────────────────────────┤
│  │              ORCHESTRATOR ENGINE                        │
│  │              (Workflow Management)                      │
│  └─────────────────────────────────────────────────────────┤
│                             │                              │
│  ┌─────────────────────────────────────────────────────────┤
│  │                GOOSE SERVER                             │
│  │            (AI Engine Backend)                         │
│  └─────────────────────────────────────────────────────────┤
│                             │                              │
│  ┌─────────────────────────────────────────────────────────┤
│  │              WEB INTERFACE                              │
│  │        (User Interaction Frontend)                     │
│  └─────────────────────────────────────────────────────────┤
│                             │                              │
│  ┌─────────────────────────────────────────────────────────┤
│  │                TTS SYSTEM                               │
│  │         (Ukrainian Text-to-Speech)                     │
│  └─────────────────────────────────────────────────────────┘
```

---

## 📁 Детальна структура проекту

### `/` - Корінь проекту
```
atlas4/
├── restart_system.sh          # 🎛️ Головний скрипт управління системою
├── shared-config.js            # 🔄 Єдина конфігурація для всієї системи
├── README.md                  # 📖 Основна документація
├── ATLAS_SYSTEM_ARCHITECTURE.md # 🏗️ Повна архітектура системи
├── Makefile                   # 🔧 Команди збірки та запуску
├── config.yaml                # ⚙️ Системна конфігурація
├── install.sh                 # 📦 Скрипт установки
├── check_goose_config.sh      # 🔍 Перевірка конфігурації Goose
├── package.json               # 📦 Node.js залежності  
├── requirements.txt           # 🐍 Python залежності основні
├── scripts/                   # 🛠️ Допоміжні скрипти
├── logs/                      # 📝 Логування системи
└── unused_files/              # 🗃️ Архів невикористаних файлів
```

**Призначення**: Основне управління та документація всієї системи.

---

### `/prompts/` - Інтелект агентів
```
prompts/
├── system/                    # 🔧 Системні промпти та правила
│   ├── state_analysis_prompts.js      # 🤖 Промпти для аналізу станів агентів
│   └── README.md                       # 📖 Документація системних промптів
├── atlas/                     # 🧠 Промпти координатора Atlas
│   ├── stage1_initial_processing.js    # 📝 Перша обробка завдання
│   ├── stage3_clarification.js         # ❓ Уточнення від користувача
│   ├── stage6_task_adjustment.js       # 🔄 Корекція завдання
│   └── stage7_retry_cycle.js           # 🔁 Новий цикл виконання
├── tetyana/                   # 💪 Промпти виконавця Tetyana
│   ├── stage2_execution.js             # ⚡ Основне виконання
│   └── stage4_retry.js                 # 🔄 Повторне виконання
└── grisha/                    # 🛡️ Промпти верифікатора Grisha
    ├── stage5_diagnosis.js             # 🔍 Діагностика проблем
    └── stage7_verification.js          # ✅ Перевірка результатів
```

**Призначення**: Містить персональності, ролі та інструкції для кожного AI-агента на різних етапах роботи.

---

### `/web/` - Веб-інтерфейс (Модульна архітектура)
```
web/
├── atlas_server.py            # 🖥️ Головний Flask сервер (порт 5002)
├── goose_client.py            # 🔌 Клієнт для Goose API
├── requirements.txt           # 🐍 Python залежності для веб-інтерфейсу
├── venv/                      # 🐍 Python віртуальне середовище
├── static/                    # 📁 Статичні ресурси
│   ├── css/main.css           # 🎨 Стилі інтерфейсу
│   ├── js/                    # 📦 Модульний JavaScript
│   │   ├── core/              # 🔧 Основні модулі
│   │   │   ├── logger.js      # 📋 Єдина система логування
│   │   │   ├── config.js      # ⚙️ Імпорт з shared-config.js
│   │   │   └── api-client.js  # 🌐 Уніфікований API клієнт
│   │   ├── modules/           # 📱 Функціональні модулі
│   │   │   ├── chat-manager.js # 💬 Управління чатом (~50KB)
│   │   │   └── tts-manager.js  # 🔊 TTS система (~30KB)
│   │   ├── app-refactored.js  # 🚀 Головний додаток
│   │   ├── index.js           # 📍 Точка входу
│   │   ├── service-worker.js  # 🔄 Service Worker (оновлений)
│   │   └── _unused/           # 🗃️ Застарілі файли (104KB intelligent-chat-manager.js)
│   └── assets/                # 🖼️ Зображення, іконки, 3D моделі
└── templates/index.html       # 📄 Головна сторінка (оновлена для ES6 модулів)
```

**Призначення**: Модульний веб-інтерфейс з чистою архітектурою для взаємодії з користувачем.

---

### `/orchestrator/` - Управління агентами (Модульна архітектура)
```
orchestrator/
├── server.js                  # 🎯 Головний оркестратор (порт 5101)
├── package.json               # 📦 Node.js залежності
├── package-lock.json          # 🔒 Зафіксовані версії залежностей
├── agents/                    # 🤖 Клієнти агентів
│   └── goose-client.js        # 🦆 WebSocket клієнт для Goose
├── ai/                        # 🧠 AI модулі
│   ├── fallback-llm.js        # 🤖 Резервний LLM
│   └── state-analyzer.js      # 📊 Аналіз станів агентів
├── config/                    # ⚙️ Конфігурації
│   └── agents.js              # 👥 Імпорт з shared-config.js
├── utils/                     # 🛠️ Утиліти
│   └── helpers.js             # 🔧 Event-based TTS, логування
├── workflow/                  # 🔄 Workflow логіка
│   ├── stages.js              # 📋 Етапи workflow (імпорт з shared-config.js)
│   ├── conditions.js          # ❓ Умови переходів
│   └── executor.js            # ⚡ Виконання workflow
└── node_modules/              # 📦 Встановлені Node.js модулі
```

**Призначення**: Модульний Node.js оркестратор з чистою архітектурою для управління workflow агентів.

---

### **ПРИМІТКА**: Застарілі модулі перенесено в архів

Папка `/config/` з Python модулями "розумної" конфігурації перенесена в `unused_files/config/` оскільки:
- ✅ **Замінено на `shared-config.js`** - єдина конфігурація для всіх компонентів
- ✅ **Спрощено архітектуру** - статичні конфігурації замість адаптивних
- ✅ **Покращено підтримку** - зрозуміла та надійна система

---

### `/ukrainian-tts/` - Система озвучування
```
ukrainian-tts/
├── tts_server.py              # 🔊 TTS сервер (порт 3001)
├── quick_tts_demo.py          # 🎤 Демо синтезу мовлення
├── model.pth                  # 🧠 Нейронна мережа (446MB)
├── config.yaml                # ⚙️ Конфігурація TTS
├── ukrainian_tts/             # 📦 Основний TTS модуль
├── vocoder/                   # 🎵 Вокодер для генерації звуку
├── fx_presets/                # 🎛️ Аудіо ефекти
└── samples/                   # 🎵 Зразки голосів
```

**Призначення**: Український TTS для озвучування відповідей агентів різними голосами.

---

### `/logs/` - Система логування
```
logs/
├── orchestrator.log           # 📝 Логи оркестратора та workflow
├── goose_web.log              # 📝 Логи Goose веб-сервера
├── frontend.log               # 📝 Логи веб-інтерфейсу
├── tts.log                    # 📝 Логи TTS системи
├── recovery_bridge.log        # 📝 Логи мостового сервісу
└── archive/                   # 📂 Архівні логи
```

**Призначення**: Централізоване логування всіх компонентів системи.

---

## 🔄 Workflow - Логіка роботи агентів

### Послідовність етапів:

1. **Stage 1**: `ATLAS` - Початкова обробка (формалізація завдання)
2. **Stage 2**: `TETYANA` - Виконання завдання  
3. **Stage 3**: `ATLAS` - Уточнення (за потреби)
4. **Stage 4**: `TETYANA` - Повторне виконання з уточненнями
5. **Stage 5**: `GRISHA` - Діагностика (якщо блокування)
6. **Stage 6**: `ATLAS` - Корекція завдання  
7. **Stage 7**: `GRISHA` - Верифікація результатів ✅
8. **Stage 8**: `SYSTEM` - Завершення workflow
9. **Stage 9**: `ATLAS` - Новий цикл (якщо потрібно)

### Ролі агентів:
- **🧠 ATLAS** (зелений) - Координатор, стратег, куратор
- **💪 TETYANA** (блакитний) - Виконавець, реалізатор завдань  
- **🛡️ GRISHA** (жовтий) - Верифікатор, контроль якості

---

## 🌐 Мережева архітектура

### Порти та сервіси:
```
┌─────────────────────────────────────────────────────────────┐
│  Port 3000: Goose Web Server     (AI Backend Engine)       │
│  Port 3001: TTS Server           (Ukrainian Text-to-Speech) │  
│  Port 5001: Frontend Server      (Web Interface)           │
│  Port 5101: Orchestrator Server  (Agent Management)        │
│  Port 5102: Recovery Bridge      (System Recovery)         │
└─────────────────────────────────────────────────────────────┘
```

### Потік даних:
```
[Користувач] → [Web UI:5001] → [Orchestrator:5101] → [Goose:3000]
                ↑                      ↓
            [TTS:3001] ← [Voice System] ← [Agent Response]
```

---

## 🛠 Технічний стек

### Backend:
- **Python 3.9+** - Основна мова для веб-сервера та TTS
- **Node.js 16+** - Оркестратор та управління workflow  
- **Flask** - Веб-фреймворк для фронтенду
- **Express.js** - API сервер для оркестратора

### AI & ML:
- **Goose Desktop/CLI** - AI движок для агентів
- **GitHub Copilot** - Базова модель для Goose
- **Ukrainian TTS Model** - Локальна нейронна мережа 446MB

### Frontend:
- **Vanilla JavaScript** - Клієнтська логіка
- **WebSocket** - Реальний час комунікації
- **Model Viewer** - 3D візуалізація
- **Responsive CSS** - Адаптивний дизайн

### DevOps:
- **Bash scripts** - Автоматизація запуску/зупинки
- **Makefile** - Команди збірки
- **Git** - Контроль версій

---

## 🚀 Команди управління

### Основні команди:
```bash
# Запуск всієї системи
./restart_system.sh start

# Зупинка системи  
./restart_system.sh stop

# Перезапуск
./restart_system.sh restart

# Діагностика
./restart_system.sh diagnose

# Перегляд статусу
./restart_system.sh status

# Очищення логів
./restart_system.sh clean
```

### Make команди:
```bash
make install    # Встановлення залежностей
make start      # Запуск системи
make stop       # Зупинка системи  
make clean      # Очищення
```

---

## 🔧 Конфігурація та налаштування

### Основні конфігураційні файли:
- `config.yaml` - Загальна конфігурація системи
- `orchestrator/workflow/stages.js` - Послідовність етапів агентів
- `config/` - Модулі конфігурації та інтеграції
- `ukrainian-tts/config.yaml` - Конфігурація TTS системи

### Змінні середовища:
- `GOOSE_SERVER_PORT=3000` - Порт Goose сервера
- `TTS_PORT=3001` - Порт TTS сервера
- `FRONTEND_PORT=5001` - Порт веб-інтерфейсу
- `ORCH_PORT=5101` - Порт оркестратора

---

## 📊 Моніторинг та логування

### Система логування:
- **Централізовані логи** в `/logs/`
- **Ротація логів** через `restart_system.sh clean`
- **Різні рівні логування** (INFO, WARN, ERROR)
- **Архівування** старих логів

### Діагностика:
- Перевірка портів та процесів
- Валідація конфігурацій
- Статус всіх сервісів
- Тестування з'єднань

---

## 🎯 Особливості системи

### Унікальні можливості:
1. **Природна комунікація агентів** - діалог як між людьми
2. **Автоматична верифікація** - Гриша перевіряє всі результати
3. **Голосове озвучування** - українські голоси для кожного агента
4. **Адаптивний workflow** - система сама вирішує, коли потрібні уточнення
5. **Повна автономність** - мінімальне втручання користувача

### Переваги архітектури:
- **Модульність** - кожен компонент незалежний
- **Масштабованість** - легко додавати нових агентів
- **Відмовостійкість** - система відновлюється після збоїв
- **Простота управління** - один скрипт для всього

---

## ⚠️ Відомі проблеми та рішення

### Проблеми з Goose:
1. **WebSocket timeout** - збільшено timeout до 120 секунд
2. **Token limit exceeded** - додано обрізання тексту до 2000 символів
3. **Authentication issues** - потрібна переавторизація через GitHub device code
4. **Payload format** - спрощено формат повідомлень WebSocket

### Проблеми з портами:
- **Recovery Bridge** може конфліктувати з іншими процесами на порті 5102
- **Frontend** іноді запускається на порту 5002 замість 5001 (автоматично змінюється)

### Рішення проблем:
```bash
# Діагностика системи
./restart_system.sh diagnose

# Переконфігурація Goose
/opt/homebrew/bin/goose configure

# Перевірка статусу
./restart_system.sh status

# Примусове звільнення портів
./restart_system.sh stop && ./restart_system.sh start
```

---

## 📈 Розвиток системи

### Поточна версія: v4.0
- ✅ 3 інтелектуальних агенти (Atlas, Tetyana, Grisha)
- ✅ Український TTS з множинними голосами
- ✅ Веб-інтерфейс з 3D візуалізацією та голосовою системою
- ✅ Автоматична верифікація результатів
- ✅ Централізоване управління через restart_system.sh
- ✅ Goose WebSocket інтеграція з retry механізмом
- ✅ Token limit захист (4000 символів)
- ✅ Fallback LLM система
- ✅ Рефакторинг структури проекту (frontend_new → web/orchestrator/config)
- ✅ Система архівування невикористаних файлів

### Планові вдосконалення:
- 🔄 Додаткові агенти-спеціалісти
- 🔄 Підтримка інших мов TTS  
- 🔄 Розширені можливості діагностики
- 🔄 API для інтеграції з іншими системами

---

*Документ створено автоматично системою ATLAS v4.0*  
*Останнє оновлення: 2025-09-20*
