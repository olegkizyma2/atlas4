# MCP Dynamic TODO Timeout Analysis
**Date**: 2025-10-14 15:34  
**Session**: session_1760445054536_g8tw80n80  
**Request**: "—Å—Ç–≤–æ—Ä–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—é –∑ —Ü—ñ–Ω–∞–º–∏ BYD Song Plus 2025"

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 1: API Timeout (60 —Å–µ–∫—É–Ω–¥)

### –°–∏–º–ø—Ç–æ–º–∏
- Stage 2.1-MCP (Tetyana Plan Tools) timeout –ø—ñ—Å–ª—è 60 —Å–µ–∫—É–Ω–¥
- Item 2 failed –ø—ñ—Å–ª—è 3 —Å–ø—Ä–æ–± (180 —Å–µ–∫—É–Ω–¥ –∑–∞–≥–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–∏—Å–∞–Ω–Ω—è)
- –°–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –ø—Ä–æ—Å—Ç–µ –∑–∞–≤–¥–∞–Ω–Ω—è

### –ü—Ä–∏—á–∏–Ω–∞
**API –Ω–∞ localhost:4000 –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π rate limits:**

```json
"mistral-ai/mistral-small-2503": {
  "per_minute": 40,
  "last429_at": 1760445476286,  // ‚Üê Rate limit error!
  "daily_requests": 63,
  "daily_errors": 1
}
```

### –ß–∞—Å–æ–≤–∞ –ª—ñ–Ω—ñ—è
```
15:30:56 - TODO —Å—Ç–≤–æ—Ä–µ–Ω–æ (24 —Å–µ–∫) ‚úÖ
15:31:20 - Item 1 –≤–∏–∫–æ–Ω–∞–Ω–æ ‚úÖ
15:32:51 - Item 2 Attempt 1 timeout (60s) ‚ùå
15:33:51 - Item 2 Attempt 2 timeout (60s) ‚ùå  
15:34:51 - Item 2 Attempt 3 timeout (60s) ‚ùå
```

### –ö–æ—Ä—ñ–Ω–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞
1. **–ó–∞–Ω–∞–¥—Ç–æ –±–∞–≥–∞—Ç–æ API calls**: 10 items = 10+ –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ API
2. **–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—è –∑–∞—Ç—Ä–∏–º–∫–∞**: 500ms –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏ –∑–∞–º–∞–ª–æ
3. **Rate limiting**: API –±–ª–æ–∫—É—î –∑–∞–ø–∏—Ç–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 2: –í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤ —á–∞—Ç—ñ

### –°–∏–º–ø—Ç–æ–º–∏
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –±–∞—á–∏—Ç—å —Ç—ñ–ª—å–∫–∏ "–û–±—Ä–æ–±–∫–∞..." –±–µ–∑ feedback
- –ñ–æ–¥–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø—Ä–æ –ø—Ä–æ–≥—Ä–µ—Å
- –ñ–æ–¥–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏

### –ü—Ä–∏—á–∏–Ω–∞
**–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ WebSocket broadcast:**

```
[WARN] [MCP-TODO] Failed to send chat message: 
this.wsManager.broadcastToSession is not a function
```

### –ö–æ—Ä—ñ–Ω–Ω–∞ –ø—Ä–∏—á–∏–Ω–∞
`MCPTodoManager` –≤–∏–∫–ª–∏–∫–∞—î –Ω–µ—ñ—Å–Ω—É—é—á–∏–π –º–µ—Ç–æ–¥ `wsManager.broadcastToSession()`.  
–ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –º–µ—Ç–æ–¥: `wsManager.broadcastToSubscribers(channel, type, data)`

---

## ‚úÖ –†—ñ—à–µ–Ω–Ω—è

### 1. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ WebSocket Broadcast
**–§–∞–π–ª**: `orchestrator/workflow/mcp-todo-manager.js`

```javascript
// BEFORE (BROKEN)
this.wsManager.broadcastToSession(this.currentSessionId, {
    type: 'chat_message',
    data: { message, messageType: type }
});

// AFTER (FIXED)
this.wsManager.broadcastToSubscribers('chat', 'chat_message', {
    message,
    messageType: type,
    sessionId: this.currentSessionId,
    timestamp: new Date().toISOString()
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ–ø–µ—Ä –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å—Å—è –≤ UI:
- ‚úÖ "üìã –ü–ª–∞–Ω —Å—Ç–≤–æ—Ä–µ–Ω–æ, 10 –ø—É–Ω–∫—Ç—ñ–≤"
- ‚úÖ "üîÑ –í–∏–∫–æ–Ω—É—é: [action]"
- ‚úÖ "‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ: [action]"
- ‚úÖ "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è: [action]"

---

### 2. –ó–±—ñ–ª—å—à–µ–Ω–æ –∑–∞—Ç—Ä–∏–º–∫—É –º—ñ–∂ API calls
**–§–∞–π–ª**: `orchestrator/workflow/mcp-todo-manager.js`

```javascript
// BEFORE
this.minApiDelay = 500; // 500ms

// AFTER
this.minApiDelay = 2000; // 2000ms to avoid rate limits
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ú–µ–Ω—à–µ rate limit errors, —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–∞ —Ä–æ–±–æ—Ç–∞

---

### 3. –î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª–µ–π
**–§–∞–π–ª–∏**: 
- `orchestrator/workflow/mcp-todo-manager.js` (createTodo, planTools)

```javascript
this.logger.system('mcp-todo', 
  `[TODO] Using model: ${modelConfig.model} (temp: ${modelConfig.temperature})`
);
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ–ø–µ—Ä –≤–∏–¥–Ω–æ, —è–∫–∞ –º–æ–¥–µ–ª—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ stage

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ Performance

### TODO Planning (Stage 1-MCP)
- **–ú–æ–¥–µ–ª—å**: `mistral-ai/mistral-small-2503`
- **–ß–∞—Å**: 24 —Å–µ–∫—É–Ω–¥–∏ ‚úÖ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: 10 items, complexity 9/10

### Tool Planning (Stage 2.1-MCP)
- **–ú–æ–¥–µ–ª—å**: `openai/gpt-4o-mini`
- **–ß–∞—Å**: 60+ —Å–µ–∫—É–Ω–¥ ‚ùå (timeout)
- **–ü—Ä–æ–±–ª–µ–º–∞**: Rate limiting

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

### –ö–æ—Ä–æ—Ç–∫–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ (DONE)
1. ‚úÖ –í–∏–ø—Ä–∞–≤–∏—Ç–∏ WebSocket broadcast
2. ‚úÖ –ó–±—ñ–ª—å—à–∏—Ç–∏ –∑–∞—Ç—Ä–∏–º–∫—É –º—ñ–∂ API calls (500ms ‚Üí 2000ms)
3. ‚úÖ –î–æ–¥–∞—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è –º–æ–¥–µ–ª–µ–π

### –°–µ—Ä–µ–¥–Ω—å–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ (TODO)
1. **Batch tool planning**: –ü–ª–∞–Ω—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö items –æ–¥—Ä–∞–∑—É
2. **–ö–µ—à—É–≤–∞–Ω–Ω—è**: –ó–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –¥–ª—è —Å—Ö–æ–∂–∏—Ö items
3. **–õ–µ–≥—à–∞ –º–æ–¥–µ–ª—å**: –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ `ministral-3b` –¥–ª—è tool planning (45 req/min)

### –î–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ (TODO)
1. **Local LLM**: –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω—É –º–æ–¥–µ–ª—å –¥–ª—è tool planning
2. **Adaptive rate limiting**: –î–∏–Ω–∞–º—ñ—á–Ω–æ –ø—ñ–¥–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–∞—Ç—Ä–∏–º–∫–∏
3. **Parallel execution**: –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ items –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ

---

## üîß Testing

### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º–∏
```bash
pkill -f "node.*orchestrator"
node orchestrator/core/application.js > logs/orchestrator.log 2>&1 &
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤
```bash
tail -f logs/orchestrator.log | grep -E "(Using model|TODO|chat_message)"
```

### –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
1. ‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è
2. ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—É—é—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –º–æ–¥–µ–ª—ñ
3. ‚úÖ –ú–µ–Ω—à–µ timeout errors
4. ‚ö†Ô∏è –ü–æ–≤—ñ–ª—å–Ω—ñ—à–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (—á–µ—Ä–µ–∑ 2s –∑–∞—Ç—Ä–∏–º–∫–∏)

---

## üìù –í–∏—Å–Ω–æ–≤–æ–∫

**–ß–æ–º—É —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Å–ø—Ä–∞–≤–∏–ª–∞—Å—è –∑ –ø—Ä–æ—Å—Ç–∏–º –∑–∞–≤–¥–∞–Ω–Ω—è–º?**

1. **API –ø–µ—Ä–µ–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏–π** - rate limiting –±–ª–æ–∫—É—î –∑–∞–ø–∏—Ç–∏
2. **WebSocket broken** - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –±–∞—á–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—É
3. **–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—è –∑–∞—Ç—Ä–∏–º–∫–∞** - 500ms –∑–∞–º–∞–ª–æ –º—ñ–∂ –∑–∞–ø–∏—Ç–∞–º–∏

**–©–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ?**

1. ‚úÖ WebSocket broadcast –ø—Ä–∞—Ü—é—î
2. ‚úÖ –ó–∞—Ç—Ä–∏–º–∫–∞ –∑–±—ñ–ª—å—à–µ–Ω–∞ –¥–æ 2s
3. ‚úÖ –î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

**–ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:**

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–∏—Å—Ç–µ–º—É —Ç–∞ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –∑ –ø—Ä–æ—Å—Ç–∏–º –∑–∞–≤–¥–∞–Ω–Ω—è–º.
