# Grisha Active Verification Fix

**Date**: 2025-10-16  
**Status**: ‚úÖ Implemented  
**Priority**: Critical

## Problem

Grisha (–≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ç–æ—Ä) —Ç—ñ–ª—å–∫–∏ **–∞–Ω–∞–ª—ñ–∑—É–≤–∞–≤ —Ç–µ–∫—Å—Ç–æ–≤—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏** –≤—ñ–¥ –¢–µ—Ç—è–Ω–∏, –∞–ª–µ **–ù–ï –≤–∏–∫–æ–Ω—É–≤–∞–≤ –≤–ª–∞—Å–Ω—ñ MCP —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏** –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏. –¶–µ –ø—Ä–∏–∑–≤–æ–¥–∏–ª–æ –¥–æ:

1. **–ù–µ–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤—ñ–∑—É–∞–ª—å–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏**: –ì—Ä—ñ—à–∞ –Ω–µ —Ä–æ–±–∏–≤ screenshot –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
2. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –¥–æ–∫–∞–∑—ñ–≤**: –ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω—É–≤–∞–ª–∏—Å—è, –∞–ª–µ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É–≤–∞–ª–∏—Å—è
3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —á–∞—Ç—ñ**: –í—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –π—à–ª–∏ –≤—ñ–¥ SYSTEM, –∞ –Ω–µ –≤—ñ–¥ –∞–≥–µ–Ω—Ç—ñ–≤ (–¢–µ—Ç—è–Ω–∞/–ì—Ä—ñ—à–∞)
4. **TTS –Ω–µ –ø—Ä–∞—Ü—é–≤–∞–≤**: TTS —Ä–µ–∞–≥—É—î –Ω–∞ —ñ–º–µ–Ω–∞ –∞–≥–µ–Ω—Ç—ñ–≤, –∞–ª–µ –≤–æ–Ω–∏ –Ω–µ –≤–∫–∞–∑—É–≤–∞–ª–∏—Å—è

### –ü—Ä–∏–∫–ª–∞–¥ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –ª–æ–≥—ñ–≤:

```
00:03:07 ‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ: "–í–≤–µ—Å—Ç–∏ 333 –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"
00:03:08 ‚ö†Ô∏è –ù–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ: "–í–≤–µ—Å—Ç–∏ 333 –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"
         –ü—Ä–∏—á–∏–Ω–∞: –ù–µ–º–∞—î –¥–æ–∫–∞–∑—ñ–≤, —â–æ 333 –≤–≤–µ–¥–µ–Ω–æ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
```

**–ü—Ä–æ–±–ª–µ–º–∞**: –ì—Ä—ñ—à–∞ –∫–∞–∂–µ "–Ω–µ–º–∞—î –¥–æ–∫–∞–∑—ñ–≤", –∞–ª–µ **–ù–ï –†–û–ë–ò–¢–¨ screenshot** —â–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏!

## Solution

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–∞ –∑–º—ñ–Ω–∞: –ì—Ä—ñ—à–∞ —Ç–µ–ø–µ—Ä –≤–∏–∫–æ–Ω—É—î 3 –µ—Ç–∞–ø–∏

**–î–æ (–ø–∞—Å–∏–≤–Ω–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è):**
```
Tetyana executes ‚Üí Grisha analyzes text ‚Üí Decision
```

**–ü—ñ—Å–ª—è (–∞–∫—Ç–∏–≤–Ω–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è):**
```
Tetyana executes ‚Üí Grisha plans tools ‚Üí Grisha executes tools ‚Üí Grisha analyzes evidence ‚Üí Decision
```

### 1. –ù–æ–≤–∏–π –º–µ—Ç–æ–¥ `_planVerificationTools()` (NEW)

–ì—Ä—ñ—à–∞ –ø–ª–∞–Ω—É—î —è–∫—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:

```javascript
async _planVerificationTools(item, execution, options = {}) {
    // Grisha decides which MCP tools to use
    // Screenshot is MANDATORY for visual verification
    
    const planPrompt = `–¢–∏ –ì—Ä–∏—à–∞ - –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ç–æ—Ä. 
    ‚ö†Ô∏è –û–ë–û–í'–Ø–ó–ö–û–í–û: –ó–ê–í–ñ–î–ò –≤–∫–ª—é—á–∞–π screenshot –¥–ª—è –≤—ñ–∑—É–∞–ª—å–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏!
    
    TODO Item: ${item.action}
    Success Criteria: ${item.success_criteria}
    Tetyana's Execution Results: ${execution.results}
    
    –û–±–µ—Ä–∏ –ú–Ü–ù–Ü–ú–ê–õ–¨–ù–ò–ô –Ω–∞–±—ñ—Ä —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤. Screenshot –û–ë–û–í'–Ø–ó–ö–û–í–ò–ô.
    
    Return ONLY JSON:
    {
      "tool_calls": [
        {"server": "shell", "tool": "run_shell_command", 
         "parameters": {"command": "screencapture -x /tmp/verify.png"}}
      ],
      "reasoning": "...",
      "tts_phrase": "–ü–µ—Ä–µ–≤—ñ—Ä—è—é –¥–æ–∫–∞–∑–∏"
    }`;
    
    // LLM generates verification plan
    const plan = this._parseToolPlan(response);
    return plan;
}
```

**–ü—Ä–∏–∫–ª–∞–¥–∏ –ø–ª–∞–Ω—ñ–≤:**
- "–í—ñ–¥–∫—Ä–∏—Ç–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä" ‚Üí `screencapture` –¥–ª—è –≤—ñ–∑—É–∞–ª—å–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- "–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª" ‚Üí `filesystem__read_file` + `screencapture`
- "–í–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç" ‚Üí `screencapture` –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞

### 2. –ù–æ–≤–∏–π –º–µ—Ç–æ–¥ `_executeVerificationTools()` (NEW)

–ì—Ä—ñ—à–∞ –≤–∏–∫–æ–Ω—É—î –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏:

```javascript
async _executeVerificationTools(plan, item) {
    const results = [];
    
    for (const toolCall of plan.tool_calls) {
        const result = await this.mcpManager.executeTool(
            toolCall.server,
            toolCall.tool,
            toolCall.parameters
        );
        
        results.push({
            tool: toolCall.tool,
            success: true,
            result
        });
    }
    
    return { results, all_successful: true };
}
```

### 3. –ù–æ–≤–∏–π –º–µ—Ç–æ–¥ `_analyzeVerificationResults()` (NEW)

–ì—Ä—ñ—à–∞ –∞–Ω–∞–ª—ñ–∑—É—î –¥–æ–∫–∞–∑–∏ —Ç–∞ —Ä–æ–±–∏—Ç—å –≤–∏—Å–Ω–æ–≤–æ–∫:

```javascript
async _analyzeVerificationResults(item, execution, verificationResults, options = {}) {
    const analysisPrompt = `–¢–∏ –ì—Ä–∏—à–∞ - –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ç–æ—Ä. 
    –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–π –¥–æ–∫–∞–∑–∏ —Ç–∞ –≤–∏–∑–Ω–∞—á —á–∏ –≤–∏–∫–æ–Ω–∞–Ω–æ –∑–∞–≤–¥–∞–Ω–Ω—è.
    
    Tetyana's Execution Results: ${execution.results}
    Grisha's Verification Evidence (screenshot, file checks): ${verificationResults.results}
    
    Return ONLY JSON:
    {
      "verified": boolean,
      "reason": "—á—ñ—Ç–∫–µ –ø–æ—è—Å–Ω–µ–Ω–Ω—è",
      "evidence": {...},
      "tts_phrase": "–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ" –∞–±–æ "–ù–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ"
    }`;
    
    const verification = this._parseVerification(response);
    return verification;
}
```

### 4. –û–Ω–æ–≤–ª–µ–Ω–∏–π –º–µ—Ç–æ–¥ `verifyItem()` (REDESIGNED)

–¢–µ–ø–µ—Ä –≤–∏–∫–ª–∏–∫–∞—î –≤—Å—ñ 3 –µ—Ç–∞–ø–∏:

```javascript
async verifyItem(item, execution, options = {}) {
    this._sendChatMessage(`üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é: "${item.action}"`, 'grisha');
    
    // STEP 1: Plan verification tools (screenshot mandatory)
    const verificationPlan = await this._planVerificationTools(item, execution, options);
    this._sendChatMessage(`[GRISHA] ${verificationPlan.tts_phrase}`, 'agent');
    
    // STEP 2: Execute verification tools
    const verificationResults = await this._executeVerificationTools(verificationPlan, item);
    
    // STEP 3: Analyze evidence and make decision
    const verification = await this._analyzeVerificationResults(item, execution, verificationResults, options);
    
    // Send result from Grisha
    if (verification.verified) {
        this._sendChatMessage(`‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ: "${item.action}"\n–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: ${verification.reason}`, 'grisha');
    } else {
        this._sendChatMessage(`‚ö†Ô∏è –ù–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ: "${item.action}"\n–ü—Ä–∏—á–∏–Ω–∞: ${verification.reason}`, 'grisha');
    }
    
    return verification;
}
```

### 5. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ —ñ–º–µ–Ω—ñ –∞–≥–µ–Ω—Ç—ñ–≤

**–¢–µ—Ç—è–Ω–∞ (–≤–∏–∫–æ–Ω–∞–Ω–Ω—è):**
```javascript
this._sendChatMessage(`‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ: "${item.action}"`, 'tetyana');
```

**–ì—Ä—ñ—à–∞ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞):**
```javascript
this._sendChatMessage(`üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é: "${item.action}"`, 'grisha');
this._sendChatMessage(`‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ: "${item.action}"`, 'grisha');
```

**Atlas (–∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è):**
```javascript
this._sendChatMessage(`üîÑ –ö–æ—Ä–∏–≥—É—é —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é`, 'atlas');
```

## Files Modified

1. **orchestrator/workflow/mcp-todo-manager.js**
   - Redesigned `verifyItem()` - Lines 706-771 (3-step verification)
   - Added `_planVerificationTools()` - Lines 1549-1624 (NEW method)
   - Added `_executeVerificationTools()` - Lines 1626-1683 (NEW method)
   - Added `_analyzeVerificationResults()` - Lines 1685-1784 (NEW method)
   - Updated `executeItemWithRetry()` - Removed duplicate messages

2. **docs/fixes/GRISHA_ACTIVE_VERIFICATION_FIX_2025-10-16.md**
   - This documentation file

## Testing

### Before Fix
```
00:03:07 ‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ: "–í–≤–µ—Å—Ç–∏ 333 –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"
00:03:08 ‚ö†Ô∏è –ù–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ: "–í–≤–µ—Å—Ç–∏ 333 –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"
         –ü—Ä–∏—á–∏–Ω–∞: –ù–µ–º–∞—î –¥–æ–∫–∞–∑—ñ–≤, —â–æ 333 –≤–≤–µ–¥–µ–Ω–æ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
         
‚ùå Grisha –ù–ï —Ä–æ–±–∏—Ç—å screenshot
‚ùå Grisha –ù–ï –ø–µ—Ä–µ–≤—ñ—Ä—è—î –≤—ñ–∑—É–∞–ª—å–Ω–æ
‚ùå –ó–∞–≤–¥–∞–Ω–Ω—è –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—é—Ç—å—Å—è
```

### After Fix (Expected)
```
00:03:07 [TETYANA] ‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ: "–í–≤–µ—Å—Ç–∏ 333 –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"
00:03:08 [GRISHA] üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é: "–í–≤–µ—Å—Ç–∏ 333 –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"
00:03:09 [GRISHA] –ü–µ—Ä–µ–≤—ñ—Ä—è—é –¥–æ–∫–∞–∑–∏
00:03:10 [GRISHA] üîß Executing screencapture -x /tmp/verify_calc.png
00:03:11 [GRISHA] ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ: "–í–≤–µ—Å—Ç–∏ 333 –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä"
         –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: Screenshot –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î —â–æ 333 –≤–≤–µ–¥–µ–Ω–æ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
         
‚úÖ Grisha –†–û–ë–ò–¢–¨ screenshot
‚úÖ Grisha –ü–ï–†–ï–í–Ü–†–Ø–Ñ –≤—ñ–∑—É–∞–ª—å–Ω–æ
‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—é—Ç—å—Å—è –∑ –¥–æ–∫–∞–∑–∞–º–∏
```

### Test Command
```bash
# Restart orchestrator
./restart_system.sh restart

# Test calculator request
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "–í—ñ–¥–∫—Ä–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ñ –ø–µ—Ä–µ–º–Ω–æ–∂ 333 –Ω–∞ 2, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø–∏—à–∏ –≤ —Ñ–∞–π–ª –£–†–ê –Ω–∞ —Ä–æ–±–æ—á–æ–º—É —Å—Ç–æ–ª—ñ"}'

# Monitor logs for Grisha's verification
tail -f logs/orchestrator.log | grep -E "(Grisha|GRISHA|üîç|screenshot)"
```

## Benefits

### 1. –í—ñ–∑—É–∞–ª—å–Ω–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è
- –ì—Ä—ñ—à–∞ —Ä–æ–±–∏—Ç—å screenshot –∫–æ–∂–Ω–æ–≥–æ –∫—Ä–æ–∫—É
- –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —á–µ—Ä–µ–∑ –≤—ñ–∑—É–∞–ª—å–Ω—ñ –¥–æ–∫–∞–∑–∏
- –ü—Ä–∞—Ü—é—î –Ω–∞–≤—ñ—Ç—å –∑ –±–∞–≥–∞—Ç—å–º–∞ –µ–∫—Ä–∞–Ω–∞–º–∏

### 2. –î–æ–∫–∞–∑–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
- –ö–æ–∂–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–∞—î –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥–æ–∫–∞–∑–∏ (screenshot, file content, etc)
- `verification.evidence` –º—ñ—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ MCP —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
- –ú–æ–∂–Ω–∞ –≤—ñ–¥—Å—Ç–µ–∂–∏—Ç–∏ –©–û —Å–∞–º–µ –ì—Ä—ñ—à–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤

### 3. –ü—Ä–∞–≤–∏–ª—å–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- –¢–µ—Ç—è–Ω–∞: –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å
- –ì—Ä—ñ—à–∞: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
- Atlas: –∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó
- TTS –ø—Ä–∞—Ü—é—î –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ –≥–æ–ª–æ—Å–∞–º–∏

### 4. –ü—ñ–¥–≤–∏—â–µ–Ω–∞ –Ω–∞–¥—ñ–π–Ω—ñ—Å—Ç—å
- –ú–µ–Ω—à–µ false negatives (–∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ, –∞–ª–µ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ)
- –ë—ñ–ª—å—à–µ true positives (–∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ –Ü –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ)
- –ö—Ä–∞—â–∞ –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–º–∏–ª–æ–∫

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TODO Item Execution                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Stage 2.1: Tetyana Plans Tools                             ‚îÇ
‚îÇ  - Determines which MCP tools to use                        ‚îÇ
‚îÇ  - Returns: {tool_calls: [...], reasoning: "..."}           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Stage 2.2: Tetyana Executes Tools                          ‚îÇ
‚îÇ  - Runs MCP tools (applescript, filesystem, etc)            ‚îÇ
‚îÇ  - Returns: {results: [...], all_successful: true/false}    ‚îÇ
‚îÇ  - Chat: "[TETYANA] ‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ"                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Stage 2.3: Grisha Verifies (NEW 3-STEP PROCESS)           ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  Step 1: Plan Verification Tools                            ‚îÇ
‚îÇ  - Grisha decides which tools to use (screenshot mandatory) ‚îÇ
‚îÇ  - Returns: {tool_calls: [...], tts_phrase: "..."}          ‚îÇ
‚îÇ  - Chat: "[GRISHA] üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—é"                            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  Step 2: Execute Verification Tools                         ‚îÇ
‚îÇ  - Grisha runs MCP tools (screencapture, read_file, etc)    ‚îÇ
‚îÇ  - Returns: {results: [...], all_successful: true/false}    ‚îÇ
‚îÇ  - Chat: "[GRISHA] –ü–µ—Ä–µ–≤—ñ—Ä—è—é –¥–æ–∫–∞–∑–∏"                        ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  Step 3: Analyze Evidence                                   ‚îÇ
‚îÇ  - Grisha analyzes Tetyana's + own results                  ‚îÇ
‚îÇ  - Returns: {verified: true/false, reason: "...", evidence} ‚îÇ
‚îÇ  - Chat: "[GRISHA] ‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ" or "‚ö†Ô∏è –ù–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ"  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ                   ‚îÇ
                verified=true      verified=false
                    ‚îÇ                   ‚îÇ
                    ‚ñº                   ‚ñº
            ‚úÖ Item Complete    üîÑ Atlas Adjusts TODO
```

## Success Criteria

- [x] Grisha plans verification tools (screenshot mandatory)
- [x] Grisha executes verification tools
- [x] Grisha analyzes evidence and makes decision
- [x] Chat messages show agent names (Tetyana/Grisha)
- [x] TTS receives agent names for voice selection
- [ ] Calculator test completes with 100% verification rate
- [ ] Screenshots are created in /tmp/ directory
- [ ] Verification evidence includes screenshot results

## Restart Required

‚ö†Ô∏è **YES** - Major architectural changes require restart:
```bash
./restart_system.sh restart
```

## Monitoring

Watch for these patterns in logs:

**Good signs:**
```
üîç Grisha planning verification tools
üìã Grisha planned 1 verification tools
üîß Grisha executing verification tools
‚úÖ Grisha tool run_shell_command succeeded
üß† Grisha analyzing verification evidence
‚úÖ VERIFIED
```

**Warning signs:**
```
‚ö†Ô∏è Grisha tool failed
‚ùå NOT VERIFIED
Verification tool planning failed
```

## Notes

- Screenshot —î –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–º –¥–ª—è –∫–æ–∂–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –ì—Ä—ñ—à–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç—ñ –∂ MCP —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —â–æ —ñ –¢–µ—Ç—è–Ω–∞
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –ì—Ä—ñ—à—ñ –Ω–∏–∂—á–∞ (0.2-0.3) –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç—ñ
- Truncation –∑–∞—Å—Ç–æ—Å–æ–≤—É—î—Ç—å—Å—è –¥–æ –≤—Å—ñ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ (300 chars)
- Rate limiting –ø—Ä–∞—Ü—é—î –¥–ª—è –≤—Å—ñ—Ö API –≤–∏–∫–ª–∏–∫—ñ–≤ –ì—Ä—ñ—à—ñ
