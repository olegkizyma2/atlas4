# –ê–Ω–∞–ª—ñ–∑ –ø—Ä–æ–±–ª–µ–º–∏ –∑ –ø–µ—Ä–µ–±—É–¥–æ–≤–æ—é TODO
**–î–∞—Ç–∞:** 2025-10-18  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—ñ—Å–ª—è –ø—Ä–æ–≤–∞–ª—É TODO items Atlas –Ω–µ –ø–µ—Ä–µ–±—É–¥–æ–≤—É—î –ø–ª–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üìä –ê–Ω–∞–ª—ñ–∑ –ª–æ–≥—ñ–≤ –∑ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É

### –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –ø–æ–¥—ñ–π:

```
16:26:15 [USER] "–Ω–∞ —Ä–æ–±–æ—á–æ–º—É —Å—Ç–æ–ª—ñ –Ω–∞–¥–∞–π –º–µ–Ω—ñ —É –≤–∏–≥–ª—è–¥—ñ –ø—Ä–∏–∑–µ–Ω—Ç–∞—Ü—ñ—ó–Ω–æ–º—É..."
16:26:30 [SYSTEM] –ü–ª–∞–Ω —Å—Ç–≤–æ—Ä–µ–Ω–æ: 5 –ø—É–Ω–∫—Ç—ñ–≤

1. ‚úÖ –í—ñ–¥–∫—Ä–∏—Ç–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–∞ auto.ria.com ‚Üí –í–ò–ö–û–ù–ê–ù–û (16:26:44)
2. ‚ùå –ó–Ω–∞–π—Ç–∏ BYD Song Plus ‚Üí –ü–†–û–í–ê–õ–ï–ù–û –ø—ñ—Å–ª—è 3 —Å–ø—Ä–æ–± (16:29:42)
   - –°–ø—Ä–æ–±–∞ 1: –≤—ñ–∑—É–∞–ª—å–Ω–æ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ (16:27:20)
   - –°–ø—Ä–æ–±–∞ 2: –≤—ñ–∑—É–∞–ª—å–Ω–æ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ (16:28:29) 
   - –°–ø—Ä–æ–±–∞ 3: –≤—ñ–∑—É–∞–ª—å–Ω–æ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ (16:29:39)
   - –ü–æ–º–∏–ª–∫–∞: "Max attempts reached"

3. ‚ùå –ó—ñ–±—Ä–∞—Ç–∏ —Ü—ñ–Ω–∏ –Ω–∞ 10 –∞–≤—Ç–æ–º–æ–±—ñ–ª—ñ–≤ ‚Üí –ü–†–û–í–ê–õ–ï–ù–û –ø—ñ—Å–ª—è 3 —Å–ø—Ä–æ–± (16:33:22)
   - –°–ø—Ä–æ–±–∞ 1-3: –≤—ñ–∑—É–∞–ª—å–Ω–æ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ
   - –ü–æ–º–∏–ª–∫–∞: "Max attempts reached"

4. ‚ö†Ô∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó ‚Üí –ü–û–ú–ò–õ–ö–ê –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è (16:33:26)
   - "–ü–ª–∞–Ω –º—ñ—Å—Ç–∏—Ç—å –Ω–µ–≤–∞–ª—ñ–¥–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏"

5. ‚ö†Ô∏è –î–æ–¥–∞—Ç–∏ –¥–∞–Ω—ñ –¥–æ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó ‚Üí –ü–û–ú–ò–õ–ö–ê –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è (16:33:36)
   - "–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–ø–ª–∞–Ω—É–≤–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏"

–†–ï–ó–£–õ–¨–¢–ê–¢: 1/5 –ø—É–Ω–∫—Ç—ñ–≤ –≤–∏–∫–æ–Ω–∞–Ω–æ (20% —É—Å–ø—ñ—Ö—É)
```

---

## üîç –í–∏—è–≤–ª–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ì—Ä—ñ—à–∞ –ø—Ä–æ–≤–∞–ª—é—î –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —á–µ—Ä–µ–∑ –≤—ñ–∑—É–∞–ª—å–Ω—É –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ—Å—Ç—å

**–°–∏–º–ø—Ç–æ–º:**
```
16:27:20 ‚ùå –í—ñ–∑—É–∞–ª—å–Ω–æ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ: "–ó–Ω–∞–π—Ç–∏ BYD Song Plus —á–µ—Ä–µ–∑ –ø–æ—à—É–∫"
–ü—Ä–∏—á–∏–Ω–∞: The screenshot does not display search results specifically for BYD Song Plus
–î–µ—Ç–∞–ª—ñ: The listings visible include Honda and Volkswagen, but BYD Song Plus is not present
```

**–î—ñ–∞–≥–Ω–æ–∑:**
- –ë—Ä–∞—É–∑–µ—Ä –≤—ñ–¥–∫—Ä–∏–≤ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø–æ—à—É–∫—É
- –¢–µ—Ç—è–Ω–∞ –≤–∏–∫–æ–Ω–∞–ª–∞ fill + click
- –ê–õ–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–∏—Å—å –∞–±–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—à—É–∫
- –ì—Ä—ñ—à–∞ –±–∞—á–∏—Ç—å —ñ–Ω—à—ñ –º–∞—à–∏–Ω–∏ (Honda, Volkswagen) –Ω–∞ —Å–∫—Ä—ñ–Ω—ñ

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ—Ç—è–Ω–∞ –≤–∏–∫–æ–Ω—É—î tools –ó–ê–ù–ê–î–¢–û –®–í–ò–î–ö–û –±–µ–∑ —á–µ–∫–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Atlas –ù–ï –ø–µ—Ä–µ–±—É–¥–æ–≤—É—î TODO –ø—ñ—Å–ª—è –ø—Ä–æ–≤–∞–ª—ñ–≤

**–ö–æ–¥:** `executor-v3.js:729-731`
```javascript
// Stage 3: Adjust TODO (if attempts remain)
if (attempt < item.max_attempts) {
  const adjustment = await this.adjustTodoItem(item, verification, attempt);
```

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- `adjustTodoItem()` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –¢–Ü–õ–¨–ö–ò —è–∫—â–æ `attempt < max_attempts`
- –ö–æ–ª–∏ –¥–æ—Å—è–≥–Ω—É—Ç–æ max_attempts (3) ‚Üí Atlas –ù–ï –∞–Ω–∞–ª—ñ–∑—É—î –ø—Ä–∏—á–∏–Ω—É –ø—Ä–æ–≤–∞–ª—É
- TODO –ø—Ä–æ—Å—Ç–æ –π–¥–µ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –ø—É–Ω–∫—Ç—É –ë–ï–ó –ø–µ—Ä–µ–±—É–¥–æ–≤–∏

**–û—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞:**
```javascript
// –ü—ñ—Å–ª—è MAX attempts - –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –ø–æ–≤–Ω–∏–π –∞–Ω–∞–ª—ñ–∑
if (attempt >= item.max_attempts && !verification.verified) {
  // FULL ANALYSIS with Grisha's screen + Tetyana's execution
  const replanResult = await this._analyzeAndReplanTodo(item, todo, tetyanaData, grishaData);
  
  if (replanResult.replanned) {
    // Rebuild TODO with new approach
  }
}
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –¢–µ—Ç—è–Ω–∞ –ø–ª–∞–Ω—É—î –ë–ê–ì–ê–¢–û tools –û–î–†–ê–ó–£

**–ü–æ—Ç–æ—á–Ω–∞ –ª–æ–≥—ñ–∫–∞:**
1. –¢–µ—Ç—è–Ω–∞ –ø–ª–∞–Ω—É—î –í–°–Ü tools –¥–ª—è item (5-10 —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤)
2. –í–∏–∫–æ–Ω—É—î —ó—Ö –í–°–Ü –ø—ñ–¥—Ä—è–¥
3. –ì—Ä—ñ—à–∞ –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ö–Ü–ù–¶–Ü

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –Ø–∫—â–æ 3-–π tool –ø—Ä–æ–≤–∞–ª–∏–≤—Å—è ‚Üí –≤—Å—ñ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Ç–µ–∂ –ø—Ä–æ–≤–∞–ª—é—é—Ç—å—Å—è
- –ù–µ–º–∞—î –ø—Ä–æ–º—ñ–∂–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –í–∞–∂–∫–æ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –¥–µ —Å–∞–º–µ –ø—Ä–æ–≤–∞–ª

**–†—ñ—à–µ–Ω–Ω—è: –ü–æ—Å—Ç—É–ø–æ–≤–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (Step-by-Step)**
```javascript
// –ù–û–í–ò–ô –ü–Ü–î–•–Ü–î: Execute tools in small batches
for (let tool of plan.tool_calls) {
  // 1. Execute single tool
  const result = await executeOneTool(tool);
  
  // 2. Quick verification (optional screenshot)
  const quickCheck = await quickVerify(tool, result);
  
  // 3. If failed - stop and adjust
  if (!quickCheck.success) {
    return { needsAdjustment: true, failedAt: tool };
  }
}
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ 4: Server Selection –æ–±–∏—Ä–∞—î —Ç—ñ–ª—å–∫–∏ 1 —Å–µ—Ä–≤–µ—Ä

**–ü—Ä–∏–∫–ª–∞–¥ –∑ –ª–æ–≥—ñ–≤:**
```
–ü—É–Ω–∫—Ç 4: "–°—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–∞–π–ª –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó BYD_Song_Plus_2025.pptx"
‚Üí Server Selection –æ–±—Ä–∞–≤: [filesystem]
‚Üí –¢–µ—Ç—è–Ω–∞ —Å–ø—Ä–æ–±—É–≤–∞–ª–∞: filesystem__write_file
‚Üí –ü–û–ú–ò–õ–ö–ê: filesystem –Ω–µ –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ PPTX —Ñ–∞–π–ª–∏
```

**–î—ñ–∞–≥–Ω–æ–∑:**
- `stage2_0_server_selection.js` –º–∞—î –ø—Ä–∞–≤–∏–ª–æ: "–Ø–∫—â–æ —Å—É–º–Ω—ñ–≤–∞—î—à—Å—è –º—ñ–∂ 1 —ñ 2 ‚Üí –æ–±–∏—Ä–∞–π 1"
- –î–ª—è PPTX –ø–æ—Ç—Ä—ñ–±–Ω–æ: shell (—Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —á–µ—Ä–µ–∑ python-pptx) + filesystem (–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è)
- –ê–õ–ï —Å–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–ª–∞ —Ç—ñ–ª—å–∫–∏ filesystem

**–†—ñ—à–µ–Ω–Ω—è:**
```javascript
// –í stage2_0_server_selection.js:
### –î–í–ê –°–ï–†–í–ï–†–ò (–∫–æ–ª–∏ –ü–û–¢–†–Ü–ë–ù–û):
- **–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—è/Excel** ‚Üí shell (python script) + filesystem (save)
- **Web + –∑–±–µ—Ä–µ–≥—Ç–∏ —Ñ–∞–π–ª** ‚Üí playwright + filesystem
- **–ö–æ–º–∞–Ω–¥–∞ + —Ñ–∞–π–ª** ‚Üí shell + filesystem
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ 5: –í—ñ–¥—Å—É—Ç–Ω—ñ–π –ø–æ–≤–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –ø—ñ—Å–ª—è –ø—Ä–æ–≤–∞–ª—É

**–©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–∞—Ä–∞–∑:**
```javascript
// mcp-todo-manager.js:729
if (attempt < item.max_attempts) {
  const adjustment = await this.adjustTodoItem(item, verification, attempt);
  // Atlas –∫–∞–∂–µ: "retry", "modify", "skip"
}
// –Ø–∫—â–æ attempt >= max_attempts ‚Üí –ù–Ü–ß–û–ì–û –ù–ï –†–û–ë–ò–¢–¨–°–Ø
```

**–©–æ –º–∞—î –±—É—Ç–∏:**
```javascript
if (!verification.verified) {
  // 1. –ó—ñ–±—Ä–∞—Ç–∏ –í–°–Ü –¥–∞–Ω—ñ
  const fullContext = {
    tetyana: { plan, execution, tools_used },
    grisha: { screenshot, visual_evidence, reason, confidence }
  };
  
  // 2. Atlas –∞–Ω–∞–ª—ñ–∑—É—î –ì–õ–ò–ë–û–ö–û
  const analysis = await atlas.deepAnalysis(fullContext);
  
  // 3. –ü—Ä–∏–π–º–∞—î —Ä—ñ—à–µ–Ω–Ω—è:
  if (analysis.canBeFixed) {
    // Replan with new approach
    const newPlan = await atlas.replan(item, analysis);
  } else {
    // Skip this item, explain why
    const skipReason = analysis.impossibleBecause;
  }
}
```

---

## üéØ –†—ñ—à–µ–Ω–Ω—è —Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### Fix 1: –ü–æ—Å—Ç—É–ø–æ–≤–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –¢–µ—Ç—è–Ω–æ—é

**–§–∞–π–ª:** `tetyana-execute-tools-processor.js`

**–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π —Ä–µ–∂–∏–º:** `step_by_step_execution`

```javascript
async execute(context) {
  const { plan, currentItem } = context;
  
  // NEW: Detect if item needs step-by-step execution
  const needsStepByStep = this._shouldExecuteStepByStep(plan, currentItem);
  
  if (needsStepByStep) {
    return await this._executeStepByStep(plan, currentItem);
  } else {
    return await this._executeBatch(plan, currentItem);
  }
}

async _executeStepByStep(plan, item) {
  const results = [];
  
  for (let i = 0; i < plan.tool_calls.length; i++) {
    const tool = plan.tool_calls[i];
    
    // Execute ONE tool
    const result = await this._executeOneTool(tool);
    results.push(result);
    
    // Quick screenshot check
    if (tool.server === 'playwright' || tool.needsVerification) {
      const screenshot = await this.visualCapture.captureScreenshot(`tool_${i}`);
      
      // Optional: Quick AI check "does this look right?"
      const quickCheck = await this._quickVisualCheck(screenshot, tool.reasoning);
      
      if (!quickCheck.looksGood) {
        // Stop here, return partial results
        return {
          success: false,
          results,
          failedAt: i,
          reason: quickCheck.reason,
          needsAdjustment: true
        };
      }
    }
    
    // Wait between tools (especially for web)
    if (tool.server === 'playwright') {
      await new Promise(resolve => setTimeout(resolve, 1500));
    }
  }
  
  return { success: true, results };
}

_shouldExecuteStepByStep(plan, item) {
  // Execute step-by-step if:
  // - More than 3 playwright tools
  // - Item has "search", "scrape", "collect" in action
  // - Previous attempt failed
  
  const playwrightTools = plan.tool_calls.filter(t => t.server === 'playwright').length;
  if (playwrightTools > 3) return true;
  
  const actionLower = item.action.toLowerCase();
  if (actionLower.includes('–∑–Ω–∞–π–¥–∏') || actionLower.includes('–∑—ñ–±—Ä–∞—Ç–∏')) return true;
  
  if (item.attempt > 1) return true;
  
  return false;
}
```

---

### Fix 2: Atlas –ø–æ–≤–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –ø—ñ—Å–ª—è max attempts

**–§–∞–π–ª:** `executor-v3.js`

**–î–æ–¥–∞—Ç–∏ –ø—ñ—Å–ª—è line 751:**

```javascript
// AFTER max attempts reached - DEEP ANALYSIS
if (attempt >= maxAttempts && !verification.verified) {
  logger.workflow('stage', 'atlas', `Stage 3.5-MCP: Deep analysis after ${maxAttempts} attempts`, {
    sessionId: session.id
  });
  
  // Prepare data for Atlas
  const tetyanaData = {
    plan: planResult.plan,
    execution: execResult.execution,
    tools_used: execResult.execution.results.map(r => r.tool)
  };
  
  const grishaData = {
    verified: false,
    reason: verifyResult.verification.reason,
    visual_evidence: verifyResult.verification.visual_evidence,
    screenshot_path: verifyResult.verification.screenshot_path,
    confidence: verifyResult.metadata.confidence
  };
  
  // Atlas analyzes deeply
  const replanResult = await adjustProcessor._analyzeAndReplanTodo(
    item,
    todo,
    tetyanaData,
    grishaData
  );
  
  // Apply replan if needed
  if (replanResult.replanned && replanResult.new_items) {
    logger.info(`Atlas replanned: ${replanResult.new_items.length} new items`, {
      sessionId: session.id
    });
    
    // Insert new items into TODO
    const currentIndex = todo.items.indexOf(item);
    todo.items.splice(currentIndex + 1, 0, ...replanResult.new_items);
    
    // Mark current item as adjusted
    item.status = 'replanned';
    item.replan_reason = replanResult.reasoning;
    
    break; // Exit retry loop, continue with new plan
  }
}
```

---

### Fix 3: Server Selection –æ–±–∏—Ä–∞—î 2 —Å–µ—Ä–≤–µ—Ä–∏ –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ

**–§–∞–π–ª:** `stage2_0_server_selection.js`

**–û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ (line 71-73):**

```javascript
### –î–í–ê –°–ï–†–í–ï–†–ò (15% –≤–∏–ø–∞–¥–∫—ñ–≤, –ù–ï 5%):
- **Web + –∑–±–µ—Ä–µ–≥—Ç–∏ —Ñ–∞–π–ª** ‚Üí playwright, filesystem
- **Web + –∑–∞–ø–∞–º'—è—Ç–∞—Ç–∏** ‚Üí playwright, memory
- **–ö–æ–º–∞–Ω–¥–∞ + —Ñ–∞–π–ª** ‚Üí shell, filesystem
- **–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—è/Excel** ‚Üí shell, filesystem (python script –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è)
- **–°–∫–ª–∞–¥–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –¥–∞–Ω–∏—Ö** ‚Üí fetch, filesystem
- **GUI + –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞** ‚Üí applescript, shell
- **Git + —Ñ–∞–π–ª–∏** ‚Üí git, filesystem

### –ü–†–ï–ó–ï–ù–¢–ê–¶–Ü–á –¢–ê –û–§–Ü–°–ù–Ü –§–ê–ô–õ–ò:
**–ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞:** –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—è, PPTX, PowerPoint, Excel, XLSX, Word, DOCX
**–ü—ñ–¥—Ö—ñ–¥:** 
1. shell ‚Üí –≤–∏–∫–æ–Ω–∞—Ç–∏ Python script (python-pptx, openpyxl)
2. filesystem ‚Üí –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –¥–∞–Ω—ñ / –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
**–°–µ—Ä–≤–µ—Ä–∏:** ["shell", "filesystem"]

**–ü—Ä–∏–∫–ª–∞–¥:**
TODO: "–°—Ç–≤–æ—Ä–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—é –∑ –¥–∞–Ω–∏–º–∏ –ø—Ä–æ —Ü—ñ–Ω–∏"
‚Üí selected_servers: ["shell", "filesystem"]
‚Üí reasoning: "shell –¥–ª—è python-pptx —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è PPTX, filesystem –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ —Ü—ñ–Ω–∏"
```

**–û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª–æ –≤–∏–±–æ—Ä—É (line 177-179):**

```javascript
‚ö†Ô∏è **–ö–†–ò–¢–ò–ß–ù–û:**
- –û–±–∏—Ä–∞–π –ú–Ü–ù–Ü–ú–£–ú —Å–µ—Ä–≤–µ—Ä—ñ–≤ (1-2, –ù–ï –±—ñ–ª—å—à–µ)
- –Ø–∫—â–æ –û–ß–ï–í–ò–î–ù–û –ø–æ—Ç—Ä—ñ–±–Ω–æ 2 ‚Üí –æ–±–∏—Ä–∞–π 2 (–Ω–µ 1)  // CHANGED
- Confidence < 0.7 ‚Üí –æ–±–∏—Ä–∞–π –±–µ–∑–ø–µ—á–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç
```

---

### Fix 4: –ì—Ä—ñ—à–∏–Ω –∞–Ω–∞–ª—ñ–∑ –¥–ª—è Atlas replan

**–§–∞–π–ª:** `grisha-verify-item-processor.js`

**–î–æ–¥–∞—Ç–∏ –º–µ—Ç–æ–¥ `getDetailedAnalysisForAtlas()`:**

```javascript
/**
 * Get detailed analysis for Atlas replanning
 * Includes all context: screenshot, visual evidence, suggestions
 */
async getDetailedAnalysisForAtlas(item, execution) {
  const verification = await this.execute({ currentItem: item, execution });
  
  return {
    verified: verification.verified,
    confidence: verification.confidence,
    reason: verification.verification.reason,
    
    // Visual evidence
    visual_evidence: {
      observed: verification.verification.visual_evidence.observed,
      matches_criteria: verification.verification.visual_evidence.matches_criteria,
      details: verification.verification.visual_evidence.details
    },
    
    // Screenshot
    screenshot_path: verification.verification.screenshot_path,
    screenshot_hash: verification.verification.screenshot_hash,
    
    // Suggestions for Atlas
    suggestions: this._generateAtlasSuggestions(verification, item),
    
    // What went wrong
    failure_analysis: this._analyzeFailure(verification, execution, item)
  };
}

_generateAtlasSuggestions(verification, item) {
  const suggestions = [];
  
  // Analyze why verification failed
  const reason = verification.verification.reason.toLowerCase();
  
  if (reason.includes('–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏–ª–æ—Å—å') || reason.includes('loading')) {
    suggestions.push('Add explicit wait for page load before scraping');
    suggestions.push('Increase timeout for navigation');
  }
  
  if (reason.includes('–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ') || reason.includes('not found')) {
    suggestions.push('Use different search strategy');
    suggestions.push('Check if search query is correct');
    suggestions.push('Try alternative selectors');
  }
  
  if (reason.includes('–Ω–µ–≤—ñ—Ä–Ω–∏–π') || reason.includes('invalid')) {
    suggestions.push('Fix tool parameters');
    suggestions.push('Use correct path/URL/selector');
  }
  
  return suggestions;
}

_analyzeFailure(verification, execution, item) {
  return {
    stage: 'verification',
    what_failed: verification.verified ? null : 'Visual verification did not match success criteria',
    execution_succeeded: execution.all_successful || false,
    visual_mismatch: !verification.verification.visual_evidence.matches_criteria,
    
    // Root cause analysis
    likely_cause: this._determineLikelyCause(verification, execution),
    
    // Recommendation
    recommended_strategy: this._recommendStrategy(verification, execution, item)
  };
}

_determineLikelyCause(verification, execution) {
  if (!execution.all_successful) {
    return 'tool_execution_failed';
  }
  
  if (verification.confidence < 50) {
    return 'unclear_state';
  }
  
  const reason = verification.verification.reason.toLowerCase();
  if (reason.includes('timeout') || reason.includes('loading')) {
    return 'timing_issue';
  }
  
  if (reason.includes('–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ') || reason.includes('–≤—ñ–¥—Å—É—Ç–Ω—ñ–π')) {
    return 'wrong_approach';
  }
  
  return 'unknown';
}

_recommendStrategy(verification, execution, item) {
  const cause = this._determineLikelyCause(verification, execution);
  
  switch (cause) {
    case 'timing_issue':
      return 'retry_with_delays';
    case 'wrong_approach':
      return 'replan_with_different_tools';
    case 'tool_execution_failed':
      return 'fix_tool_parameters';
    default:
      return 'modify_or_split';
  }
}
```

---

## üìù –ü–æ—Ä—è–¥–æ–∫ –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è

### –ö—Ä–æ–∫ 1: Step-by-step execution (HIGH PRIORITY)
1. –î–æ–¥–∞—Ç–∏ `_executeStepByStep()` –≤ `tetyana-execute-tools-processor.js`
2. –î–æ–¥–∞—Ç–∏ `_shouldExecuteStepByStep()` –ª–æ–≥—ñ–∫—É
3. –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–º—ñ–∂–Ω—ñ screenshot checks

### –ö—Ä–æ–∫ 2: Full analysis after max attempts (HIGH PRIORITY)
1. –û–Ω–æ–≤–∏—Ç–∏ `executor-v3.js` line 751+
2. –í–∏–∫–ª–∏–∫–∞—Ç–∏ `_analyzeAndReplanTodo()` –ø—ñ—Å–ª—è max attempts
3. –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ replan result –¥–æ TODO list

### –ö—Ä–æ–∫ 3: Enhanced Grisha analysis (HIGH PRIORITY)
1. –î–æ–¥–∞—Ç–∏ `getDetailedAnalysisForAtlas()` –≤ `grisha-verify-item-processor.js`
2. –î–æ–¥–∞—Ç–∏ `_generateAtlasSuggestions()`
3. –î–æ–¥–∞—Ç–∏ `_analyzeFailure()`

### –ö—Ä–æ–∫ 4: Better Server Selection (MEDIUM PRIORITY)
1. –û–Ω–æ–≤–∏—Ç–∏ rules –≤ `stage2_0_server_selection.js`
2. –î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ–π/Excel
3. –ó–º—ñ–Ω–∏—Ç–∏ "—è–∫—â–æ —Å—É–º–Ω—ñ–≤–∞—î—à—Å—è ‚Üí 1" –Ω–∞ "—è–∫—â–æ –æ—á–µ–≤–∏–¥–Ω–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ 2 ‚Üí 2"

### –ö—Ä–æ–∫ 5: Testing (CRITICAL)
1. –¢–µ—Å—Ç –∫–µ–π—Å: BYD Song Plus –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—è (—è–∫ –≤ –ª–æ–≥–∞—Ö)
2. –¢–µ—Å—Ç –∫–µ–π—Å: Web scraping –∑ –±–∞–≥–∞—Ç—å–º–∞ –∫—Ä–æ–∫–∞–º–∏
3. –¢–µ—Å—Ç –∫–µ–π—Å: –§–∞–π–ª–æ–≤—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó + –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—è

---

## üéØ –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

### –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:
```
‚úÖ 1/5 items completed (20%)
‚ùå 2 items failed (max attempts)
‚ö†Ô∏è 2 items invalid tools
```

### –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:
```
‚úÖ 4/5 items completed (80%+)
üîÑ 1 item replanned ‚Üí success
üìä Step-by-step execution prevents early failures
üß† Atlas learns from Grisha's visual analysis
```

---

## üìå –ö–ª—é—á–æ–≤—ñ –ø—Ä–∏–Ω—Ü–∏–ø–∏

1. **–ü–æ—Å—Ç—É–ø–æ–≤—ñ—Å—Ç—å:** –í–∏–∫–æ–Ω—É–≤–∞—Ç–∏ tools –ø–æ 1-2, –Ω–µ –≤—Å—ñ –æ–¥—Ä–∞–∑—É
2. **–ê–Ω–∞–ª—ñ–∑:** –ü—ñ—Å–ª—è –ø—Ä–æ–≤–∞–ª—É - –ø–æ–≤–Ω–∏–π –∞–Ω–∞–ª—ñ–∑ –∑ –ì—Ä—ñ—à–µ—é
3. **–ê–¥–∞–ø—Ç–∞—Ü—ñ—è:** Atlas –ø–µ—Ä–µ–±—É–¥–æ–≤—É—î –ø–ª–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤—ñ–∑—É–∞–ª—å–Ω–∏—Ö –¥–æ–∫–∞–∑—ñ–≤
4. **–¢–æ—á–Ω—ñ—Å—Ç—å:** Server Selection –æ–±–∏—Ä–∞—î 2 —Å–µ—Ä–≤–µ—Ä–∏ –∫–æ–ª–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ
5. **Feedback loop:** –¢–µ—Ç—è–Ω–∞ ‚Üí –≤–∏–∫–æ–Ω–∞–Ω–Ω—è ‚Üí –ì—Ä—ñ—à–∞ ‚Üí –∞–Ω–∞–ª—ñ–∑ ‚Üí Atlas ‚Üí replan

---

**–ê–≤—Ç–æ—Ä:** Cascade AI  
**–î–∞—Ç–∞:** 2025-10-18T16:50:00+03:00
