# üîß Model 413 Error & Chat Fix - 14.10.2025

## üìã –ü—Ä–æ–±–ª–µ–º–∏ —è–∫—ñ –±—É–ª–∏ –≤–∏—è–≤–ª–µ–Ω—ñ

### 1. ‚ùå –ü–æ–º–∏–ª–∫–∞ 413: Request body too large
**–ü—Ä–æ–±–ª–µ–º–∞:** `ministral-3b` –º–∞—î –ª—ñ–º—ñ—Ç 8000 —Ç–æ–∫–µ–Ω—ñ–≤, –∞–ª–µ –ø—Ä–æ–º–ø—Ç–∏ –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ç–∞ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è –º—ñ—Å—Ç—è—Ç—å –±–∞–≥–∞—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É

**–ü–æ–º–∏–ª–∫–∞:**
```
‚ùå 413 Request body too large for ministral-3b model. Max size: 8000 tokens
```

**–î–µ –≤–∏–Ω–∏–∫–∞–ª–∞:**
- **Stage 2.1-MCP (Tetyana Plan Tools)** - —Å–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö –¥–æ—Å—Ç—É–ø–Ω–∏—Ö MCP —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ (92 tools)
- **Stage 2.3-MCP (Grisha Verify Item)** - execution results + available tools –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
- **Stage 3-MCP (Atlas Adjust TODO)** - –ø–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ—Ä–µ–∫—Ü—ñ—ó TODO

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –°–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–≥–ª–∞ –≤–µ—Ä–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å
- –í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –ø–∞–¥–∞–ª–∏ –Ω–∞ –µ—Ç–∞–ø—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –ù–µ–º–æ–∂–ª–∏–≤–æ –±—É–ª–æ —Å–∫–æ—Ä–∏–≥—É–≤–∞—Ç–∏ TODO –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–æ–∫

### 2. ‚ùå –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–µ –∑'—è–≤–ª—è—é—Ç—å—Å—è –≤ —á–∞—Ç—ñ
**–ü—Ä–æ–±–ª–µ–º–∞:** WebSocket –∫–ª—ñ—î–Ω—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –Ω–µ –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ –Ω–∞ –∫–∞–Ω–∞–ª `chat`

**–ö–æ–¥:**
```javascript
// ‚ùå –ë–£–õ–û:
subscriptions: new Set(['logs', 'model3d', 'tts']) // –ù–µ–º–∞—î 'chat'!
```

**–ù–∞—Å–ª—ñ–¥–∫–∏:**
- –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –±–∞—á–∏—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ —Å–∏—Å—Ç–µ–º–∏
- –ù–µ–º–∞—î —Ñ—ñ–¥–±–µ–∫—É –ø—Ä–æ –ø—Ä–æ–≥—Ä–µ—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
- –ß–∞—Ç –∑–¥–∞—î—Ç—å—Å—è "–º–µ—Ä—Ç–≤–∏–º"

## ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

### 1. –ó–∞–º—ñ–Ω–∞ –º–æ–¥–µ–ª–µ–π –Ω–∞ —Ç—ñ —â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å –±—ñ–ª—å—à–∏–π context

**–§–∞–π–ª:** `config/global-config.js`

**–ó–º—ñ–Ω–∏:**

```javascript
// ‚ùå –ë–£–õ–û (8K context):
plan_tools: {
  get model() { return process.env.MCP_MODEL_PLAN_TOOLS || 'mistral-ai/ministral-3b'; },
  max_tokens: 800,
  description: 'Tool matching - —à–≤–∏–¥–∫–∞ –º–æ–¥–µ–ª—å –∑ –≤–∏—Å–æ–∫–∏–º rate limit'
},

verify_item: {
  get model() { return process.env.MCP_MODEL_VERIFY_ITEM || 'mistral-ai/ministral-3b'; },
  max_tokens: 300,
  description: '–ü—Ä–æ—Å—Ç–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è success/fail (45 req/min)'
},

adjust_todo: {
  get model() { return process.env.MCP_MODEL_ADJUST_TODO || 'mistral-ai/ministral-3b'; },
  max_tokens: 1000,
  description: '–ö–æ—Ä–µ–∫—Ü—ñ—è TODO - —à–≤–∏–¥–∫–∞ –º–æ–¥–µ–ª—å –∑ –≤–∏—Å–æ–∫–∏–º rate limit (45 req/min)'
},

// ‚úÖ –°–¢–ê–õ–û (128K context):
plan_tools: {
  get model() { return process.env.MCP_MODEL_PLAN_TOOLS || 'mistral-ai/mistral-nemo'; },
  max_tokens: 800,
  description: 'Tool matching - 128K context –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö —Å–ø–∏—Å–∫—ñ–≤ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤'
},

verify_item: {
  get model() { return process.env.MCP_MODEL_VERIFY_ITEM || 'mistral-ai/mistral-nemo'; },
  max_tokens: 300,
  description: '–í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑ –≤–µ–ª–∏–∫–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º execution results (128K context)'
},

adjust_todo: {
  get model() { return process.env.MCP_MODEL_ADJUST_TODO || 'mistral-ai/mistral-nemo'; },
  max_tokens: 1000,
  description: '–ö–æ—Ä–µ–∫—Ü—ñ—è TODO –∑ –ø–æ–≤–Ω–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (128K context)'
},
```

**–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –º–æ–¥–µ–ª–µ–π:**

| –ú–æ–¥–µ–ª—å | Context Length | Rate Limit | –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è |
|--------|---------------|------------|--------------|
| `ministral-3b` | 8K tokens | 45 req/min | ‚ùå –ó–∞–Ω–∞–¥—Ç–æ –º–∞–ª–æ –¥–ª—è MCP |
| `mistral-small-2503` | 32K tokens | 40 req/min | ‚úÖ TODO Planning |
| `mistral-nemo` | 128K tokens | 14 req/min | ‚úÖ Plan Tools, Verify, Adjust |
| `gpt-4o-mini` | 128K tokens | 35 req/min | ‚ö° –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (—à–≤–∏–¥—à–µ) |

**–ß–æ–º—É mistral-nemo?**
- ‚úÖ 128K context - –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è –±—É–¥—å-—è–∫–æ–≥–æ –ø—Ä–æ–º–ø—Ç—É
- ‚úÖ 14 req/min - –ø—Ä–∏–π–Ω—è—Ç–Ω–∏–π rate limit
- ‚úÖ –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π —á–µ—Ä–µ–∑ OpenRouter
- ‚úÖ –Ø–∫—ñ—Å–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–ª—è reasoning

### 2. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ WebSocket –ø—ñ–¥–ø–∏—Å–∫–∏

**–§–∞–π–ª:** `orchestrator/api/websocket-manager.js`

**–ó–º—ñ–Ω–∏:**

```javascript
// ‚ùå –ë–£–õ–û:
subscriptions: new Set(['logs', 'model3d', 'tts']) // –ù–µ–º–∞—î chat!

// ‚úÖ –°–¢–ê–õ–û:
subscriptions: new Set(['logs', 'model3d', 'tts', 'chat', 'workflow']) // FIXED 14.10.2025
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ö–ª—ñ—î–Ω—Ç–∏ –æ—Ç—Ä–∏–º—É—é—Ç—å chat –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- ‚úÖ –í–∏–¥–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å
- ‚úÖ Workflow –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏

### –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:
- ‚ùå –ü–æ–º–∏–ª–∫–∞ 413 –Ω–∞ –∫–æ–∂–Ω—ñ–π –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
- ‚ùå –°–∏—Å—Ç–µ–º–∞ –Ω–µ –º–æ–∂–µ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ –∂–æ–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è
- ‚ùå –ß–∞—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π, –Ω–µ–º–∞—î —Ñ—ñ–¥–±–µ–∫—É
- ‚ùå Rate limit 45 req/min –≤–∏—Ç—Ä–∞—á–∞—î—Ç—å—Å—è –¥–∞—Ä–µ–º–Ω–æ

### –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:
- ‚úÖ –ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫ 413
- ‚úÖ –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø—Ä–∞—Ü—é—î –∑ –ø–æ–≤–Ω–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ –ß–∞—Ç –ø–æ–∫–∞–∑—É—î –≤—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
- ‚úÖ Workflow –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ
- ‚úÖ Rate limit 14 req/min –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è —Ä–æ–±–æ—Ç–∏

## üîç –Ø–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏

### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–¥–µ–ª–µ–π:
```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ orchestrator
npm run start

# –î–∞—Ç–∏ —Å–∫–ª–∞–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è:
"–ó–Ω–∞–π–¥–∏ BYD Song Plus 2025 –Ω–∞ auto.ria, —Å—Ç–≤–æ—Ä–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—é –∑ —Ü—ñ–Ω–∞–º–∏"
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫ 413
- –í–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—è –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —É—Å–ø—ñ—à–Ω–æ
- –ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –¥–æ –∫—ñ–Ω—Ü—è

### 2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∞—Ç—É:
```bash
# –í—ñ–¥–∫—Ä–∏—Ç–∏ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
open http://localhost:5101

# –î–∞—Ç–∏ –±—É–¥—å-—è–∫–µ –∑–∞–≤–¥–∞–Ω–Ω—è
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑'—è–≤–ª—è—é—Ç—å—Å—è –≤ —á–∞—Ç—ñ
- –í–∏–¥–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å: "–ü–ª–∞–Ω —Å—Ç–≤–æ—Ä–µ–Ω–æ", "–í–∏–∫–æ–Ω—É—é –ø—É–Ω–∫—Ç 1", —Ç–æ—â–æ
- Workflow –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤:
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —â–æ –Ω–µ–º–∞—î 413:
grep "413" logs/orchestrator.log

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ WebSocket –ø—ñ–¥–ø–∏—Å–∫–∏:
grep "subscriptions" logs/orchestrator.log
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ù–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫ 413
- –ü—ñ–¥–ø–∏—Å–∫–∏ –º—ñ—Å—Ç—è—Ç—å: `['logs', 'model3d', 'tts', 'chat', 'workflow']`

## üìù –î–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω–æ—Ç–∞—Ç–∫–∏

### –ß–æ–º—É —Å–∞–º–µ —Ü—ñ —Å—Ç–µ–π–¥–∂—ñ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –≤–µ–ª–∏–∫–æ–≥–æ context?

**Stage 2.1 (Plan Tools):**
- –°–ø–∏—Å–æ–∫ –≤—Å—ñ—Ö 92 MCP —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
- –û–ø–∏—Å –∫–æ–∂–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
- –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
- –ü—Ä–∞–≤–∏–ª–∞ –ø–ª–∞–Ω—É–≤–∞–Ω–Ω—è
- **–ó–∞–≥–∞–ª–æ–º:** ~6000-8000 —Ç–æ–∫–µ–Ω—ñ–≤

**Stage 2.3 (Verify Item):**
- Success criteria
- Execution results (–º–æ–∂–µ –±—É—Ç–∏ –¥—É–∂–µ –≤–µ–ª–∏–∫–∏–º)
- Available tools –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
- –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
- **–ó–∞–≥–∞–ª–æ–º:** ~5000-10000 —Ç–æ–∫–µ–Ω—ñ–≤

**Stage 3 (Adjust TODO):**
- –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–≤–¥–∞–Ω–Ω—è
- –Ü—Å—Ç–æ—Ä—ñ—è —Å–ø—Ä–æ–±
- Execution results
- Verification results
- –°—Ç—Ä–∞—Ç–µ–≥—ñ—ó –∫–æ—Ä–µ–∫—Ü—ñ—ó
- **–ó–∞–≥–∞–ª–æ–º:** ~4000-8000 —Ç–æ–∫–µ–Ω—ñ–≤

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ –º–æ–¥–µ–ª—ñ

–Ø–∫—â–æ `mistral-nemo` –Ω–µ –≤–ª–∞—à—Ç–æ–≤—É—î (–ø–æ–≤—ñ–ª—å–Ω–∏–π), –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏:

```bash
# –í .env –∞–±–æ export:
export MCP_MODEL_PLAN_TOOLS="openai/gpt-4o-mini"
export MCP_MODEL_VERIFY_ITEM="openai/gpt-4o-mini"
export MCP_MODEL_ADJUST_TODO="openai/gpt-4o-mini"
```

**gpt-4o-mini:**
- 128K context
- 35 req/min (—à–≤–∏–¥—à–µ –Ω—ñ–∂ mistral-nemo)
- –¢—Ä–æ—Ö–∏ –¥–æ—Ä–æ–∂—á–µ —á–µ—Ä–µ–∑ OpenRouter

### Rate Limit Management

–ó –Ω–æ–≤–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏:
- `mistral-small-2503`: 40 req/min (TODO Planning)
- `mistral-nemo`: 14 req/min (Plan/Verify/Adjust)
- `ministral-3b`: 45 req/min (Mode Selection, Final Summary)

**–ó–∞–≥–∞–ª—å–Ω–∏–π throughput:** ~14 req/min (–æ–±–º–µ–∂–µ–Ω–∏–π –Ω–∞–π–ø–æ–≤—ñ–ª—å–Ω—ñ—à–æ—é –º–æ–¥–µ–ª–ª—é)

–¶–µ –ø—Ä–∏–π–Ω—è—Ç–Ω–æ –¥–ª—è –±—ñ–ª—å—à–æ—Å—Ç—ñ –∑–∞–≤–¥–∞–Ω—å, –æ—Å–∫—ñ–ª—å–∫–∏:
- TODO Planning: 1 —Ä–∞–∑ –Ω–∞ –∑–∞–≤–¥–∞–Ω–Ω—è
- Plan Tools: 1 —Ä–∞–∑ –Ω–∞ –∫–æ–∂–µ–Ω –ø—É–Ω–∫—Ç
- Verify: 1-3 —Ä–∞–∑–∏ –Ω–∞ –ø—É–Ω–∫—Ç (–∑ retry)
- Adjust: —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö

## ‚úÖ –°—Ç–∞—Ç—É—Å
- **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ:** 14.10.2025 19:45
- **–¢–µ—Å—Ç–æ–≤–∞–Ω–æ:** –ù—ñ (–ø–æ—Ç—Ä—ñ–±–µ–Ω –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫)
- **–ì–æ—Ç–æ–≤–æ –¥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:** –¢–∞–∫

## üöÄ –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏

1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ orchestrator
2. –ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ —Å–∫–ª–∞–¥–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è
3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∞—Ç –≤ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ
4. –ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏ rate limits
