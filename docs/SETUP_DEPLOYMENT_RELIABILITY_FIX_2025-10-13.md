# Setup Deployment Reliability Fix — 2025-10-13

## Overview
- **Дата:** 2025-10-13
- **Компонент:** `setup-macos.sh`
- **Мета:** Надійне завантаження моделей Whisper та коректні значення `.env` під час автоматичного розгортання

## Проблема
- Скрипт вважав завантаження Whisper Large-v3 успішним навіть при мережевих помилках.
- `.env` жорстко задавав `WHISPER_CPP_THREADS=6`, ігноруючи кількість ядер та вже встановлені змінні оточення.

## Симптоми
- Порожній або пошкоджений `models/whisper/ggml-large-v3.bin`, але установка продовжувалась без помилок.
- Whisper service падав під час запуску (`No such file or directory` / `failed to load model`).
- На машинах з >6 ядрами використовувався неповний потенціал CPU, а користувацькі значення `WHISPER_CPP_DISABLE_GPU/THREADS` перезаписувались.

## Логи
- `wget: unable to resolve host ...` (але скрипт показував `Модель завантажена`).
- `whisper-cli: failed to init model models/whisper/ggml-large-v3.bin` під час старту сервісу.

## Корінь
1. Команда `wget --show-progress ... | grep ... | tail -1` завжди повертала успішний exit code (через pipeline без `pipefail`).
2. `.env` генерувався без перевірки існуючих змінних та без урахування фактичної кількості CPU ядер.

## Рішення
- Увімкнули `set -o pipefail`, щоб pipeline враховували реальний статус помилки.
- Переписали завантаження моделі на використання тимчасового файлу та явну перевірку розміру після переміщення.
- Додали fallback на `curl` / `wget` із видаленням частково завантажених файлів.
- Динамічно визначаємо `WHISPER_CPP_THREADS` (кількість ядер macOS), задаємо дефолтний `WHISPER_CPP_BIN` на зібраний `third_party/whisper.cpp.upstream/build/bin/whisper-cli` та поважаємо попередньо встановлені `GOOSE_BIN`, `TTS_DEVICE`, `WHISPER_DEVICE`, `WHISPER_CPP_DISABLE_GPU`.

## Виправлено
- `setup-macos.sh`

## Результат
- Скрипт зупиняється при невдалому завантаженні Large-v3 та не залишає пошкоджених артефактів.
- `.env` використовує оптимальну кількість потоків та не перезаписує користувацькі значення.
- Whisper service запускається стабільно після розгортання.

## Критично
- Залишайте `curl` або `wget` встановленими; без них встановлення буде зупинено.
- Для CPU fallback використовуйте `export WHISPER_CPP_DISABLE_GPU=true` **до** запуску скрипта — значення буде збережено в `.env`.

## Тестування
- Ручна перевірка: завантаження моделі з відключеним інтернетом → скрипт завершується з помилкою.
- Повторний запуск після відновлення мережі → модель завантажується, `.env` містить фактичний `WHISPER_CPP_THREADS`.
