# üéØ VAD & Conversation Loop - –ö–æ–º–ø–ª–µ–∫—Å–Ω–µ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è

**–î–∞—Ç–∞:** 11 –∂–æ–≤—Ç–Ω—è 2025, ~17:00-17:30  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û –í–°–Ü 3 –ü–†–û–ë–õ–ï–ú–ò

---

## üìä –†–µ–∑—é–º–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å

### 1Ô∏è‚É£ Race Condition –≤ Conversation Recording
- **–ë—É–ª–æ:** `handleConversationRecordingStart()` –≤—ñ–¥–∫–∏–¥–∞–≤ –∑–∞–ø–∏—Ç —è–∫—â–æ state !== 'idle'
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ü—ñ—Å–ª—è TTS state –º—ñ–≥ –±—É—Ç–∏ 'processing' ‚Üí conversation –ù–ï –ø–æ—á–∏–Ω–∞–≤—Å—è
- **–†—ñ—à–µ–Ω–Ω—è:** –î–æ–∑–≤–æ–ª–µ–Ω–æ states ['idle', 'processing'] + auto-reset
- **–§–∞–π–ª:** `microphone-button-service.js`

### 2Ô∏è‚É£ –ü—É—Å—Ç–∞ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è
- **–ë—É–ª–æ:** WhisperService –µ–º—ñ—Ç—É–≤–∞–≤ `{ result: {text} }`
- **–ü—Ä–æ–±–ª–µ–º–∞:** ConversationMode –æ—á—ñ–∫—É–≤–∞–≤ `{ text }` –∞–±–æ `{ text, result }`
- **–†—ñ—à–µ–Ω–Ω—è:** –î–æ–¥–∞–Ω–æ `text` –Ω–∞ –≤–µ—Ä—Ö–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å payload
- **–§–∞–π–ª:** `whisper-service.js`

### 3Ô∏è‚É£ Voice Activity Detection (VAD)
- **–ë—É–ª–æ:** –§—ñ–∫—Å–æ–≤–∞–Ω–∏–π —á–∞—Å –∑–∞–ø–∏—Å—É (6 —Å–µ–∫)
- **–ü—Ä–æ–±–ª–µ–º–∞:** –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º—É—Å–∏–≤ —á–µ–∫–∞—Ç–∏ –∞–±–æ –æ–±—Ä—ñ–∑–∞–≤—Å—è mid-sentence
- **–†—ñ—à–µ–Ω–Ω—è:** –°—Ç–≤–æ—Ä–µ–Ω–æ SimpleVAD –∑ auto-detection –∫—ñ–Ω—Ü—è —Ñ—Ä–∞–∑–∏
- **–§–∞–π–ª–∏:** `simple-vad.js` (NEW), `media-manager.js` (integration)

---

## üöÄ Workflow –ø—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å

```
–£—Ç—Ä–∏–º–∞–Ω–Ω—è 2—Å –∫–Ω–æ–ø–∫–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
  ‚Üì
Conversation Mode –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è
  ‚Üì
Keyword Detection: —á–µ–∫–∞—î–º–æ "–ê—Ç–ª–∞—Å"
  ‚Üì
–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–∞–∂–µ "–ê—Ç–ª–∞—Å"
  ‚Üì
Recording START –∑ VAD
  ‚îú‚îÄ –ê–Ω–∞–ª—ñ–∑ RMS —Ä—ñ–≤–Ω—è (real-time)
  ‚îú‚îÄ –í–∏—è–≤–ª–µ–Ω–Ω—è –º–æ–≤–∏ ‚Üí speechStartTime
  ‚îú‚îÄ –í–∏—è–≤–ª–µ–Ω–Ω—è –ø–∞—É–∑–∏ 1.5 —Å–µ–∫ ‚Üí AUTO-STOP ‚ú®
  ‚îî‚îÄ Blob ‚Üí Whisper
  ‚Üì
–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è
  ‚îú‚îÄ Whisper —Ä–æ–∑–ø—ñ–∑–Ω–∞—î
  ‚îú‚îÄ –ï–º—ñ—Ç—É—î { text, result, ... } ‚ú®
  ‚îî‚îÄ ConversationMode –æ—Ç—Ä–∏–º—É—î text ‚úÖ
  ‚Üì
–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ —á–∞—Ç ‚Üí Atlas –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î
  ‚Üì
TTS playback
  ‚îú‚îÄ isInConversation: true ‚ú®
  ‚îî‚îÄ TTS_COMPLETED event
  ‚Üì
Continuous Listening (–ë–ï–ó "–ê—Ç–ª–∞—Å")
  ‚îú‚îÄ State: 'processing' –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π ‚ú®
  ‚îú‚îÄ Auto-reset to 'idle'
  ‚îî‚îÄ Recording START –∑ VAD
  ‚Üì
REPEAT —Ü–∏–∫–ª—ñ—á–Ω–æ ‚ôªÔ∏è
```

---

## ‚úÖ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### –û—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–≤–µ–¥—ñ–Ω–∫–∞:

1. ‚úÖ –£—Ç—Ä–∏–º–∞—Ç–∏ –∫–Ω–æ–ø–∫—É 2—Å ‚Üí Conversation –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è
2. ‚úÖ –°–∫–∞–∑–∞—Ç–∏ "–ê—Ç–ª–∞—Å" ‚Üí Keyword detected
3. ‚úÖ **–ì–æ–≤–æ—Ä–∏—Ç–∏ —Ñ—Ä–∞–∑—É** ‚Üí VAD —Å–ª—É—Ö–∞—î
4. ‚úÖ **–ó—Ä–æ–±–∏—Ç–∏ –ø–∞—É–∑—É 1.5 —Å–µ–∫** ‚Üí AUTO-STOP (–ù–ï —á–µ–∫–∞—Ç–∏ 6 —Å–µ–∫!)
5. ‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü—ñ—è –∑'—è–≤–ª—è—î—Ç—å—Å—è –≤ —á–∞—Ç—ñ (–ù–ï –ø—É—Å—Ç–∞)
6. ‚úÖ Atlas –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —á–µ—Ä–µ–∑ TTS
7. ‚úÖ **–ê–í–¢–û–ú–ê–¢–ò–ß–ù–û** –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å (–ë–ï–ó "–ê—Ç–ª–∞—Å")
8. ‚úÖ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ 3-7 (—Ü–∏–∫–ª—ñ—á–Ω–æ)

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ VAD (Browser Console):

```javascript
// –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞–Ω VAD
window.app.managers.voiceControl.services.get('microphone').mediaManager.vad?.getState()

// –†–µ–∑—É–ª—å—Ç–∞—Ç (–ø—ñ–¥ —á–∞—Å —Ä–æ–∑–º–æ–≤–∏):
// { isActive: true, isSpeaking: true, speechDuration: 2500, silenceDuration: 0 }

// –†–µ–∑—É–ª—å—Ç–∞—Ç (–ø—ñ—Å–ª—è –ø–∞—É–∑–∏):
// { isActive: true, isSpeaking: false, speechDuration: 0, silenceDuration: 1500 }
```

---

## üìù –í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ —Ñ–∞–π–ª–∏ (4):

1. `web/static/js/voice-control/services/microphone-button-service.js`
2. `web/static/js/voice-control/services/whisper-service.js`
3. `web/static/js/voice-control/services/microphone/simple-vad.js` ‚≠ê NEW
4. `web/static/js/voice-control/services/microphone/media-manager.js`

---

## üéØ –ö–ª—é—á–æ–≤—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è

- ‚úÖ **–ü—Ä–∏—Ä–æ–¥–Ω–∞ –≤–∑–∞—î–º–æ–¥—ñ—è:** –ì–æ–≤–æ—Ä–∏ ‚Üí –ø–∞—É–∑–∞ ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Å—Ç–æ–ø
- ‚úÖ **–®–≤–∏–¥–∫—ñ—Å—Ç—å:** –°—Ç–æ–ø –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è —Ñ—Ä–∞–∑–∏ (–∑–∞–º—ñ—Å—Ç—å 6 —Å–µ–∫)
- ‚úÖ **–¢–æ—á–Ω—ñ—Å—Ç—å:** 300–º—Å min –≤—ñ–¥—Å—ñ—é—î —à—É–º
- ‚úÖ **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å:** Conversation loop –ø—Ä–∞—Ü—é—î –ë–ï–ó –ø—Ä–æ–±–ª–µ–º
- ‚úÖ **Debug:** –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –µ—Ç–∞–ø—ñ–≤

---

**Access:** http://localhost:5001  
**–î–µ—Ç–∞–ª—å–Ω–æ:** `docs/VAD_CONVERSATION_LOOP_FIX_2025-10-11.md`
