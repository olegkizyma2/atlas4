#!/bin/bash

# –¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ì—Ä–∏—à—ñ - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
# –î–∞—Ç–∞: 10 –∂–æ–≤—Ç–Ω—è 2025

echo "üß™ –¢–µ—Å—Ç –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ì—Ä–∏—à—ñ –∑ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏"
echo "=========================================="
echo ""

SESSION_ID="test_grisha_$(date +%s)"

echo "üìù –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–≤–¥–∞–Ω–Ω—è: –í—ñ–¥–∫—Ä–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ñ –Ω–∞–ø–∏—à–∏ 777"
echo "Session ID: $SESSION_ID"
echo ""

# –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–∞–ø–∏—Ç
curl -s -X POST http://localhost:5101/chat/stream \
  -H "Content-Type: application/json" \
  -d "{\"message\": \"–í—ñ–¥–∫—Ä–∏–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —ñ –Ω–∞–ø–∏—à–∏ 777\", \"sessionId\": \"$SESSION_ID\"}" \
  > /tmp/grisha_test_response.txt &

CURL_PID=$!

# –ß–µ–∫–∞—î–º–æ 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
sleep 30

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ª–æ–≥–∏
echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª–æ–≥—ñ–≤ –ì—Ä–∏—à—ñ:"
echo "========================"
echo ""

echo "1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤:"
tail -200 logs/orchestrator.log | grep -i "grisha" | grep -E "playwright|screenshot|browser_take|computercontrol|developer" | tail -5

if [ $? -eq 0 ]; then
    echo "‚úÖ –ì—Ä–∏—à–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏!"
else
    echo "‚ùå –ì—Ä–∏—à–∞ –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏"
fi

echo ""
echo "2. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–µ—Ä–¥–∏–∫—Ç—É –ì—Ä–∏—à—ñ:"
tail -100 logs/orchestrator.log | grep -A 2 "–ì–†–ò–®–ê\|grisha.*complete" | tail -10

echo ""
echo "3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ stage 8 (completion):"
tail -100 logs/orchestrator.log | grep -i "stage.*8\|completion" | tail -5

if [ $? -eq 0 ]; then
    echo "‚úÖ Stage 8 –≤–∏–∫–æ–Ω–∞–≤—Å—è!"
else
    echo "‚ö†Ô∏è Stage 8 –º–æ–∂–ª–∏–≤–æ –Ω–µ –≤–∏–∫–æ–Ω–∞–≤—Å—è"
fi

echo ""
echo "üìä –ü–æ–≤–Ω–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥—å:"
cat /tmp/grisha_test_response.txt | grep -E "–ì–†–ò–®–ê|–¢–ï–¢–Ø–ù–ê|–ê–¢–õ–ê–°|SYSTEM" | tail -10

echo ""
echo "‚úÖ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∏ –ì—Ä–∏—à–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –≤–∏—â–µ."
