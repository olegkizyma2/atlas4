#!/bin/bash
# VAD & Conversation Loop Test Script
# Created: 2025-10-11 17:30

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  VAD & Conversation Loop - Automated Test Instructions  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ¯ Test Goals:"
echo "  1. Voice Activity Detection (VAD) works"
echo "  2. Conversation loop continues after TTS"
echo "  3. Transcription NOT empty"
echo "  4. Race condition fixed"
echo ""
echo "ğŸ“‹ Test Steps:"
echo ""
echo "1. Open http://localhost:5001 in browser"
echo ""
echo "2. Open Browser Console (F12 â†’ Console)"
echo ""
echo "3. Hold microphone button for 2 seconds"
echo "   Expected: [CONVERSATION_MODE] ğŸ¬ Activating conversation mode..."
echo ""
echo "4. Say 'ĞÑ‚Ğ»Ğ°Ñ'"
echo "   Expected: [WHISPER_KEYWORD] ğŸ¯ KEYWORD DETECTED!"
echo ""
echo "5. Say any phrase (e.g., 'ĞŸÑ€Ğ¸Ğ²Ñ–Ñ‚')"
echo "   Expected: [VAD: Speech started]"
echo ""
echo "6. âš¡ PAUSE for 1.5 seconds (CRITICAL TEST!)"
echo "   Expected: [VAD: Silence detected (1500ms) - triggering auto-stop]"
echo "             [Stopping recording (reason: silence)]"
echo ""
echo "7. Check transcription appears (NOT empty!)"
echo "   Expected: [Transcription successful: 'your text here']"
echo "             âš ï¸ NOT: [Transcription completed but no text found]"
echo ""
echo "8. Atlas responds via TTS"
echo "   Expected: [TTS] Speaking for atlas..."
echo ""
echo "9. âš¡ After TTS completes (CRITICAL TEST!)"
echo "   Expected: [APP] ğŸ”Š Emitting TTS_COMPLETED:"
echo "               isInConversation: true  â† MUST BE TRUE!"
echo "             [CONVERSATION] ğŸ”Š Atlas finished speaking - starting continuous listening"
echo "             [MICROPHONE_BUTTON] Starting recording (trigger: conversation_continuous)"
echo ""
echo "10. Say another phrase WITHOUT 'ĞÑ‚Ğ»Ğ°Ñ'"
echo "    Expected: Recording starts automatically â†’ VAD â†’ transcription â†’ repeat"
echo ""
echo "âœ… SUCCESS CRITERIA:"
echo "   âœ“ VAD auto-stops after 1.5 sec silence"
echo "   âœ“ Transcription has text (NOT empty)"
echo "   âœ“ isInConversation: true in TTS_COMPLETED"
echo "   âœ“ Continuous recording starts after TTS"
echo "   âœ“ NO 'Invalid state transition' errors"
echo ""
echo "âŒ FAILURE INDICATORS:"
echo "   âœ— Recording waits full 6 seconds (VAD NOT working)"
echo "   âœ— 'Transcription completed but no text found'"
echo "   âœ— isInConversation: false in TTS_COMPLETED"
echo "   âœ— 'Conversation recording ignored - current state: X'"
echo "   âœ— Must say 'ĞÑ‚Ğ»Ğ°Ñ' again for next recording"
echo ""
echo "ğŸ” Debug Commands (Browser Console):"
echo ""
echo "// Check VAD state during recording"
echo "window.app.managers.voiceControl.services.get('microphone').mediaManager.vad?.getState()"
echo ""
echo "// Check conversation mode state"
echo "window.app.managers.conversationMode.isConversationActive()"
echo ""
echo "// Check microphone state"
echo "window.app.managers.voiceControl.services.get('microphone').currentState"
echo ""
echo "ğŸ“Š Check logs:"
echo "tail -f logs/orchestrator.log | grep -E 'VAD|CONVERSATION|TTS_COMPLETED|Transcription'"
echo ""
echo "ğŸš€ System ready at http://localhost:5001"
echo ""
